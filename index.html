<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ˜“è¶£SafePay - æ™ºèƒ½USDTæ‹…ä¿äº¤æ˜“å¹³å°</title>
<style>
  :root{
    --bg-dark:#0a0e1a;
    --bg-card:#131825;
    --bg-hover:#1a2235;
    --border:#2a3245;
    --text-primary:#ffffff;
    --text-secondary:#94a3b8;
    --text-muted:#64748b;
    --primary:#3b82f6;
    --primary-dark:#2563eb;
    --success:#10b981;
    --warning:#f59e0b;
    --danger:#ef4444;
    --info:#06b6d4;
  }
  
  *{margin:0;padding:0;box-sizing:border-box}
  
  body{
    background:var(--bg-dark);
    background-image:radial-gradient(circle at 20% 80%, #1e40af15 0%, transparent 50%),
                     radial-gradient(circle at 80% 20%, #7c3aed15 0%, transparent 50%),
                     radial-gradient(circle at 40% 40%, #10b98115 0%, transparent 50%);
    font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
    color:var(--text-primary);
    min-height:100vh;
  }
  
  .container{
    max-width:1280px;
    margin:0 auto;
    padding:24px;
  }
  
  .navbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:20px 0;
    margin-bottom:32px;
    border-bottom:1px solid var(--border);
  }
  
  .logo{
    display:flex;
    align-items:center;
    gap:12px;
    font-size:24px;
    font-weight:700;
  }
  
  .logo-icon{
    width:40px;
    height:40px;
    background:linear-gradient(135deg, var(--primary), var(--info));
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  
  .nav-right{
    display:flex;
    align-items:center;
    gap:24px;
  }
  
  .user-info{
    display:flex;
    align-items:center;
    gap:12px;
    padding:8px 16px;
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:12px;
  }
  
  .reputation-score{
    display:flex;
    align-items:center;
    gap:4px;
    padding:4px 8px;
    background:rgba(16,185,129,0.1);
    border-radius:6px;
    font-size:13px;
    color:var(--success);
  }
  
  .kyc-badge{
    padding:4px 8px;
    background:rgba(59,130,246,0.1);
    border:1px solid rgba(59,130,246,0.3);
    border-radius:6px;
    font-size:11px;
    color:var(--primary);
    font-weight:600;
  }
  
  .user-address-display{
    font-family:monospace;
    font-size:14px;
    color:var(--primary);
  }
  
  .login-card{
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:20px;
    padding:32px;
    margin-bottom:32px;
    box-shadow:0 10px 30px rgba(0,0,0,0.2);
  }
  
  .login-card-header{
    display:flex;
    align-items:center;
    gap:16px;
    margin-bottom:24px;
  }
  
  .login-card-icon{
    width:56px;
    height:56px;
    background:linear-gradient(135deg, var(--primary), var(--info));
    border-radius:14px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:28px;
  }
  
  .login-card-title{
    flex:1;
  }
  
  .login-card-title h2{
    font-size:22px;
    font-weight:700;
    margin-bottom:4px;
  }
  
  .login-card-subtitle{
    font-size:14px;
    color:var(--text-secondary);
  }
  
  .login-status-badge{
    padding:8px 16px;
    background:rgba(16,185,129,0.1);
    border:1px solid rgba(16,185,129,0.3);
    border-radius:10px;
    color:var(--success);
    font-weight:600;
    font-size:14px;
    display:none;
  }
  
  .login-status-badge.show{
    display:block;
  }
  
  .login-form-container{
    display:flex;
    gap:16px;
    align-items:center;
  }
  
  .login-input-wrapper{
    flex:1;
    position:relative;
  }
  
  .login-input-field{
    width:100%;
    padding:14px 16px 14px 48px;
    background:var(--bg-hover);
    border:2px solid var(--border);
    border-radius:12px;
    color:var(--text-primary);
    font-size:15px;
    font-family:monospace;
    transition:all 0.3s;
  }
  
  .login-input-icon{
    position:absolute;
    left:16px;
    top:50%;
    transform:translateY(-50%);
    color:var(--text-muted);
    font-size:18px;
  }
  
  .login-input-field:focus{
    outline:none;
    border-color:var(--primary);
    background:rgba(59,130,246,0.05);
  }
  
  .login-input-field:disabled{
    background:rgba(16,185,129,0.05);
    border-color:rgba(16,185,129,0.3);
    color:var(--success);
    cursor:not-allowed;
  }
  
  .login-buttons{
    display:flex;
    gap:12px;
  }
  
  .login-btn{
    padding:14px 28px;
    border:none;
    border-radius:12px;
    font-size:15px;
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s;
    display:inline-flex;
    align-items:center;
    gap:8px;
    white-space:nowrap;
  }
  
  .login-btn.primary{
    background:linear-gradient(135deg, var(--primary), var(--primary-dark));
    color:white;
  }
  
  .login-btn.primary:hover:not(:disabled){
    transform:translateY(-2px);
    box-shadow:0 8px 24px rgba(59,130,246,0.3);
  }
  
  .login-btn.secondary{
    background:linear-gradient(135deg, var(--warning), #dc2626);
    color:white;
  }
  
  .login-btn.secondary:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 24px rgba(245,158,11,0.3);
  }
  
  .login-btn:disabled{
    opacity:0.5;
    cursor:not-allowed;
  }
  
  .login-tips{
    margin-top:20px;
    padding:16px;
    background:rgba(59,130,246,0.05);
    border:1px solid rgba(59,130,246,0.2);
    border-radius:12px;
    font-size:13px;
    line-height:1.8;
    color:var(--text-secondary);
  }
  
  .main-grid{
    display:grid;
    grid-template-columns:2fr 1fr;
    gap:24px;
  }
  
  .card{
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:20px;
    padding:28px;
  }
  
  .card-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
  }
  
  .card-title{
    font-size:20px;
    font-weight:600;
  }
  
  .role-selector{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin-bottom:24px;
  }
  
  .role-option{
    padding:16px;
    background:var(--bg-hover);
    border:2px solid var(--border);
    border-radius:12px;
    cursor:pointer;
    transition:all 0.3s;
    text-align:center;
  }
  
  .role-option:hover{
    border-color:var(--primary);
    background:rgba(59,130,246,0.05);
  }
  
  .role-option.selected{
    border-color:var(--primary);
    background:rgba(59,130,246,0.1);
  }
  
  .role-icon{
    font-size:28px;
    margin-bottom:8px;
  }
  
  .role-name{
    font-weight:600;
    margin-bottom:4px;
  }
  
  .role-desc{
    font-size:12px;
    color:var(--text-muted);
  }
  
  .form-group{
    margin-bottom:20px;
  }
  
  .form-row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:16px;
  }
  
  label{
    display:block;
    font-size:13px;
    color:var(--text-secondary);
    margin-bottom:8px;
    font-weight:500;
  }
  
  .required{
    color:var(--danger);
  }
  
  input, textarea{
    width:100%;
    padding:12px 14px;
    background:var(--bg-hover);
    border:1px solid var(--border);
    border-radius:10px;
    color:var(--text-primary);
    font-size:14px;
    transition:all 0.3s;
  }
  
  input:focus, textarea:focus{
    outline:none;
    border-color:var(--primary);
    background:rgba(59,130,246,0.05);
  }
  
  select{
    width:100%;
    padding:12px 40px 12px 14px;
    background-color:var(--bg-hover);
    border:1px solid var(--border);
    border-radius:10px;
    color:var(--text-primary);
    font-size:14px;
    transition:all 0.3s;
    cursor:pointer;
    -webkit-appearance:none;
    -moz-appearance:none;
    appearance:none;
    background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat:no-repeat;
    background-position:right 12px center;
    background-size:20px;
  }
  
  select:focus{
    outline:none;
    border-color:var(--primary);
    background-color:rgba(59,130,246,0.05);
  }
  
  select option{
    background-color:var(--bg-card);
    color:var(--text-primary);
    padding:8px;
    font-size:14px;
  }
  
  select option:hover{
    background-color:var(--bg-hover);
  }
  
  select option:checked{
    background:linear-gradient(to right, var(--primary), var(--primary));
    color:white;
  }
  
  @-moz-document url-prefix(){
    select{
      background-color:var(--bg-hover) !important;
      color:var(--text-primary) !important;
    }
    select option{
      background-color:var(--bg-card) !important;
      color:var(--text-primary) !important;
    }
  }
  
  @media screen and (-webkit-min-device-pixel-ratio:0){
    select option{
      background-color:#131825 !important;
      color:#ffffff !important;
    }
  }
  
  textarea{
    min-height:100px;
    resize:vertical;
  }
  
  .risk-assessment{
    background:var(--bg-hover);
    border-radius:12px;
    padding:16px;
    margin-bottom:20px;
  }
  
  .risk-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
  }
  
  .risk-title{
    font-size:14px;
    font-weight:600;
  }
  
  .risk-score{
    display:flex;
    align-items:center;
    gap:8px;
  }
  
  .risk-value{
    font-size:20px;
    font-weight:700;
  }
  
  .risk-level{
    padding:4px 8px;
    border-radius:6px;
    font-size:11px;
    font-weight:600;
  }
  
  .risk-low{
    background:rgba(16,185,129,0.1);
    color:var(--success);
  }
  
  .risk-medium{
    background:rgba(245,158,11,0.1);
    color:var(--warning);
  }
  
  .risk-high{
    background:rgba(239,68,68,0.1);
    color:var(--danger);
  }
  
  .risk-factors{
    display:grid;
    gap:8px;
  }
  
  .risk-factor{
    display:flex;
    justify-content:space-between;
    font-size:12px;
    padding:6px 0;
    border-bottom:1px solid var(--border);
  }
  
  .risk-factor:last-child{
    border-bottom:none;
  }
  
  .factor-label{
    color:var(--text-muted);
  }
  
  .factor-value{
    font-weight:500;
  }
  
  .fee-breakdown{
    background:linear-gradient(135deg, rgba(59,130,246,0.05), rgba(6,182,212,0.05));
    border:1px solid rgba(59,130,246,0.2);
    border-radius:12px;
    padding:16px;
    margin-bottom:20px;
  }
  
  .fee-row{
    display:flex;
    justify-content:space-between;
    padding:8px 0;
    font-size:14px;
  }
  
  .fee-row.total{
    border-top:1px solid rgba(59,130,246,0.2);
    margin-top:8px;
    padding-top:12px;
    font-weight:600;
    font-size:16px;
  }
  
  .fee-label{
    color:var(--text-secondary);
  }
  
  .fee-value{
    color:var(--text-primary);
    font-family:'Courier New', monospace;
  }
  
  .limit-info{
    background:rgba(245,158,11,0.05);
    border:1px solid rgba(245,158,11,0.2);
    border-radius:10px;
    padding:12px;
    margin-bottom:20px;
    display:flex;
    align-items:center;
    gap:12px;
  }
  
  .limit-icon{
    font-size:20px;
  }
  
  .limit-text{
    flex:1;
    font-size:13px;
    color:var(--text-secondary);
  }
  
  .limit-values{
    display:flex;
    gap:16px;
    font-size:12px;
  }
  
  .limit-item{
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  
  .limit-label{
    color:var(--text-muted);
    margin-bottom:4px;
  }
  
  .limit-amount{
    color:var(--warning);
    font-weight:600;
  }
  
  .btn{
    padding:12px 24px;
    border:none;
    border-radius:10px;
    font-size:15px;
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }
  
  .btn:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 20px rgba(0,0,0,0.3);
  }
  
  .btn-primary{
    background:linear-gradient(135deg, var(--primary), var(--primary-dark));
    color:white;
  }
  
  .btn-secondary{
    background:var(--bg-hover);
    color:var(--text-primary);
    border:1px solid var(--border);
  }
  
  .btn-group{
    display:flex;
    gap:12px;
    justify-content:flex-end;
    margin-top:24px;
  }
  
  .security-features{
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:20px;
    padding:28px;
  }
  
  .feature-list{
    display:grid;
    gap:16px;
  }
  
  .feature-item{
    display:flex;
    align-items:flex-start;
    gap:12px;
  }
  
  .feature-icon{
    width:32px;
    height:32px;
    background:rgba(16,185,129,0.1);
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-shrink:0;
  }
  
  .feature-content{
    flex:1;
  }
  
  .feature-title{
    font-size:14px;
    font-weight:600;
    margin-bottom:4px;
  }
  
  .feature-desc{
    font-size:12px;
    color:var(--text-muted);
    line-height:1.5;
  }
  
  .live-transactions{
    margin-top:24px;
  }
  
  .transaction-item{
    display:flex;
    align-items:center;
    padding:12px;
    background:var(--bg-hover);
    border-radius:10px;
    margin-bottom:8px;
    font-size:13px;
  }
  
  .transaction-status{
    width:8px;
    height:8px;
    border-radius:50%;
    margin-right:12px;
    flex-shrink:0;
  }
  
  .status-active{
    background:var(--success);
    animation:pulse 2s infinite;
  }
  
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(16,185,129,0.4)}
    70%{box-shadow:0 0 0 10px rgba(16,185,129,0)}
    100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}
  }
  
  .transaction-info{
    flex:1;
  }
  
  .transaction-id{
    font-family:'Courier New', monospace;
    color:var(--text-muted);
    font-size:11px;
  }
  
  .transaction-amount{
    font-weight:600;
    color:var(--primary);
  }
  
  /* ========== ç»Ÿä¸€çš„å¼¹çª—æ ·å¼ ========== */
  
  /* å¼¹çª—é®ç½©å±‚ */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    animation: fadeInModal 0.3s ease;
  }
  
  /* å¼¹çª—å®¹å™¨ */
  .modal-container {
    background: var(--bg-card);
    background-image: radial-gradient(circle at top left, rgba(59,130,246,0.05), transparent),
                      radial-gradient(circle at bottom right, rgba(16,185,129,0.05), transparent);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 32px;
    max-width: 90%;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                0 0 100px rgba(59, 130, 246, 0.1);
    animation: slideUpModal 0.3s ease;
  }
  
  /* å¼¹çª—å¤§å°å˜ä½“ */
  .modal-container.small {
    max-width: 400px;
  }
  
  .modal-container.medium {
    max-width: 600px;
  }
  
  .modal-container.large {
    max-width: 800px;
  }
  
  /* å¼¹çª—å¤´éƒ¨ */
  .modal-header {
    text-align: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }
  
  .modal-icon {
    font-size: 48px;
    margin-bottom: 16px;
    display: block;
  }
  
  .modal-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
  }
  
  .modal-subtitle {
    font-size: 13px;
    color: var(--text-muted);
  }
  
  /* å¼¹çª—å†…å®¹ */
  .modal-body {
    margin-bottom: 24px;
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-line;
  }
  
  .modal-info-section {
    margin-bottom: 20px;
    padding: 16px;
    background: var(--bg-hover);
    border-radius: 12px;
  }
  
  .modal-info-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-secondary);
  }
  
  .modal-info-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 13px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  
  .modal-info-row:last-child {
    border-bottom: none;
  }
  
  /* å¼¹çª—åŠ¨ä½œæŒ‰é’® */
  .modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }
  
  .modal-btn {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
    outline: none;
  }
  
  .modal-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  .modal-btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .modal-btn-primary:hover {
    background: var(--primary-dark);
  }
  
  .modal-btn-secondary {
    background: var(--bg-hover);
    color: var(--text-primary);
    border: 1px solid var(--border);
  }
  
  .modal-btn-secondary:hover {
    border-color: var(--primary);
    background: rgba(59, 130, 246, 0.1);
  }
  
  .modal-btn-success {
    background: var(--success);
    color: white;
  }
  
  .modal-btn-warning {
    background: var(--warning);
    color: white;
  }
  
  .modal-btn-danger {
    background: var(--danger);
    color: white;
  }
  
  /* Toast é€šçŸ¥æ ·å¼ */
  .toast {
    position: fixed;
    top: 24px;
    right: 24px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    z-index: 2000;
    animation: slideInRightToast 0.3s ease;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    max-width: 400px;
  }
  
  .toast-icon {
    font-size: 20px;
  }
  
  .toast-message {
    flex: 1;
    color: var(--text-primary);
  }
  
  .toast-close {
    cursor: pointer;
    opacity: 0.5;
    transition: opacity 0.3s;
  }
  
  .toast-close:hover {
    opacity: 1;
  }
  
  .toast.success {
    border-color: var(--success);
    background: linear-gradient(to right, rgba(16, 185, 129, 0.1), var(--bg-card));
  }
  
  .toast.warning {
    border-color: var(--warning);
    background: linear-gradient(to right, rgba(245, 158, 11, 0.1), var(--bg-card));
  }
  
  .toast.error {
    border-color: var(--danger);
    background: linear-gradient(to right, rgba(239, 68, 68, 0.1), var(--bg-card));
  }
  
  .toast.info {
    border-color: var(--info);
    background: linear-gradient(to right, rgba(6, 182, 212, 0.1), var(--bg-card));
  }
  
  /* åŠ¨ç”» */
  @keyframes fadeInModal {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  
  @keyframes slideUpModal {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  @keyframes slideInRightToast {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @media (max-width:968px){
    .main-grid{
      grid-template-columns:1fr;
    }
    .login-form-container{
      flex-direction:column;
      align-items:stretch;
    }
    .login-buttons{
      width:100%;
    }
    .login-btn{
      flex:1;
    }
    .modal-container {
      max-width: 95%;
      padding: 24px;
    }
  }
  
  @media (max-width:640px){
    .form-row{
      grid-template-columns:1fr;
    }
    .role-selector{
      grid-template-columns:1fr;
    }
    .nav-right{
      flex-direction:column;
      gap:12px;
    }
    .login-card-header{
      flex-direction:column;
      text-align:center;
    }
    .modal-container {
      padding: 20px;
    }
    .modal-actions {
      flex-direction: column;
    }
  }
</style>
</head>
<body>

<div class="container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <nav class="navbar">
    <div class="logo">
      <div class="logo-icon">ğŸ”</div>
      <span>æ˜“è¶£SafePay</span>
    </div>
    <div class="nav-right">
      <div class="user-info">
        <div class="reputation-score">
          <span>â­</span>
          <span>ä¿¡èª‰åˆ†: <span id="userScore">--</span></span>
        </div>
        <span class="kyc-badge">KYC L<span id="kycLevel">-</span></span>
        <span class="user-address-display">ç”¨æˆ·: <span id="userAddressDisplay">æœªç™»å½•</span></span>
      </div>
    </div>
  </nav>
  
  <!-- ç™»å½•å¡ç‰‡ -->
  <div class="login-card">
    <div class="login-card-header">
      <div class="login-card-icon">ğŸ’¼</div>
      <div class="login-card-title">
        <h2>é’±åŒ…åœ°å€ç™»å½•</h2>
        <p class="login-card-subtitle">è¾“å…¥æ‚¨çš„USDTé’±åŒ…åœ°å€ä»¥å¼€å§‹ä½¿ç”¨</p>
      </div>
      <div class="login-status-badge" id="loginStatusBadge">
        âœ“ å·²ç™»å½•
      </div>
    </div>
    
    <div class="login-form-container">
      <div class="login-input-wrapper">
        <span class="login-input-icon">ğŸ’³</span>
        <input type="text" 
               id="walletAddress" 
               class="login-input-field" 
               placeholder="è¯·è¾“å…¥USDTé’±åŒ…åœ°å€ (TRC20: Tå¼€å¤´34ä½ / ERC20/BEP20: 0xå¼€å¤´42ä½)">
      </div>
      <div class="login-buttons">
        <button class="login-btn primary" id="loginBtn" onclick="handleLogin()">
          <span>ğŸ”</span>
          <span>ç™»å…¥</span>
        </button>
        <button class="login-btn secondary" id="resetBtn" onclick="handleReset()">
          <span>ğŸ”„</span>
          <span>é‡æ–°ç™»å…¥</span>
        </button>
      </div>
    </div>
    
    <div class="login-tips">
      <strong>ğŸ’¡ æç¤ºï¼š</strong>
      â€¢ æ”¯æŒ TRC-20 (æ³¢åœºï¼ŒTå¼€å¤´34ä½)ã€ERC-20 (ä»¥å¤ªåŠï¼Œ0xå¼€å¤´42ä½)ã€BEP-20 (å¸å®‰æ™ºèƒ½é“¾ï¼Œ0xå¼€å¤´42ä½) ç½‘ç»œé’±åŒ…åœ°å€<br>
      â€¢ æ— éœ€ç§é’¥æˆ–åŠ©è®°è¯ï¼Œä»…ä½¿ç”¨å…¬å¼€åœ°å€<br>
      â€¢ æ‚¨çš„èµ„äº§å§‹ç»ˆåœ¨æ‚¨çš„é’±åŒ…ä¸­ï¼Œå¹³å°ä»…æä¾›æ‹…ä¿æœåŠ¡
    </div>
  </div>
  
  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <div class="main-grid">
    <!-- å·¦ä¾§ä¸»è¦å†…å®¹ -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">åˆ›å»ºæ™ºèƒ½æ‹…ä¿äº¤æ˜“</h2>
        <span style="padding:6px 12px;background:rgba(16,185,129,0.1);color:var(--success);border-radius:20px;font-size:12px;font-weight:600;">
          å®‰å…¨æ¨¡å¼å¯ç”¨
        </span>
      </div>
      
      <!-- è§’è‰²é€‰æ‹© -->
      <div class="role-selector">
        <div class="role-option selected" onclick="selectRole('buyer', this)">
          <div class="role-icon">ğŸ›’</div>
          <div class="role-name">æˆ‘æ˜¯ä¹°æ–¹</div>
          <div class="role-desc">è´­ä¹°å•†å“æˆ–æœåŠ¡</div>
        </div>
        <div class="role-option" onclick="selectRole('seller', this)">
          <div class="role-icon">ğŸ’¼</div>
          <div class="role-name">æˆ‘æ˜¯å–æ–¹</div>
          <div class="role-desc">å‡ºå”®å•†å“æˆ–æœåŠ¡</div>
        </div>
      </div>
      
      <!-- äº¤æ˜“è¡¨å• -->
      <form id="escrowForm">
        <div class="form-group">
          <label>å¯¹æ–¹é’±åŒ…åœ°å€ <span class="required">*</span></label>
          <input type="text" id="counterpartyAddress" placeholder="è¾“å…¥å¯¹æ–¹é’±åŒ…åœ°å€ (TRC20: Tå¼€å¤´ / ERC20/BEP20: 0xå¼€å¤´)" onblur="checkAddress(this.value)">
          <div id="addressWarning" style="display:none;margin-top:8px;padding:8px;background:rgba(239,68,68,0.1);border-radius:6px;font-size:12px;color:var(--danger);">
            âš ï¸ è¯¥åœ°å€å­˜åœ¨é£é™©è®°å½•
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>äº¤æ˜“é‡‘é¢ (USDT) <span class="required">*</span></label>
            <input type="number" id="amount" step="0.01" min="10" placeholder="æœ€ä½ 10 USDT" oninput="updateRiskAssessment()">
          </div>
          <div class="form-group">
            <label>é€‰æ‹©ç½‘ç»œ <span class="required">*</span></label>
            <select id="network" onchange="updateFees()">
              <option value="TRC20">TRC-20 (æ¨è)</option>
              <option value="ERC20">ERC-20</option>
              <option value="BEP20">BEP-20</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>æ‰˜ç®¡æœŸé™ <span class="required">*</span></label>
            <select id="escrowPeriod">
              <option value="24">24å°æ—¶ - å¿«é€Ÿäº¤æ˜“</option>
              <option value="72" selected>3å¤© - æ ‡å‡†äº¤æ˜“</option>
              <option value="168">7å¤© - å¤§é¢äº¤æ˜“</option>
              <option value="360">15å¤© - å®šåˆ¶äº¤æ˜“</option>
            </select>
          </div>
          <div class="form-group">
            <label>äº¤æ˜“ç±»å‹</label>
            <select id="transactionType" onchange="updateRiskAssessment()">
              <option value="goods">å®ç‰©å•†å“</option>
              <option value="digital">æ•°å­—å•†å“</option>
              <option value="service">æœåŠ¡ç±»</option>
              <option value="other">å…¶ä»–</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label>äº¤æ˜“æè¿°</label>
          <textarea id="description" placeholder="è¯¦ç»†æè¿°äº¤æ˜“å†…å®¹ï¼Œä¾¿äºäº‰è®®å¤„ç†"></textarea>
        </div>
        
        <!-- é£é™©è¯„ä¼° -->
        <div class="risk-assessment">
          <div class="risk-header">
            <span class="risk-title">ğŸ›¡ï¸ é£é™©è¯„ä¼°</span>
            <div class="risk-score">
              <span class="risk-value" id="riskScore">25</span>
              <span class="risk-level risk-low" id="riskLevel">ä½é£é™©</span>
            </div>
          </div>
          <div class="risk-factors">
            <div class="risk-factor">
              <span class="factor-label">å¯¹æ–¹ä¿¡èª‰</span>
              <span class="factor-value" id="counterpartyRep">å¾…éªŒè¯</span>
            </div>
            <div class="risk-factor">
              <span class="factor-label">äº¤æ˜“é‡‘é¢</span>
              <span class="factor-value" id="amountRisk">æ­£å¸¸</span>
            </div>
            <div class="risk-factor">
              <span class="factor-label">äº¤æ˜“é¢‘ç‡</span>
              <span class="factor-value">æ­£å¸¸</span>
            </div>
            <div class="risk-factor">
              <span class="factor-label">åœ°å€é£é™©</span>
              <span class="factor-value" id="addressRisk">å¾…æ£€æµ‹</span>
            </div>
          </div>
        </div>
        
        <!-- é™é¢æç¤º -->
        <div class="limit-info">
          <span class="limit-icon">âš ï¸</span>
          <div class="limit-text">
            æ‚¨çš„å½“å‰äº¤æ˜“é™é¢ï¼ˆåŸºäºKYCç­‰çº§å’Œä¿¡èª‰åˆ†ï¼‰
          </div>
          <div class="limit-values">
            <div class="limit-item">
              <span class="limit-label">å•ç¬”</span>
              <span class="limit-amount">$150,000</span>
            </div>
            <div class="limit-item">
              <span class="limit-label">æ¯æ—¥</span>
              <span class="limit-amount">$1,000,000</span>
            </div>
            <div class="limit-item">
              <span class="limit-label">æ¯æœˆ</span>
              <span class="limit-amount">$50,000,000</span>
            </div>
          </div>
        </div>
        
        <!-- è´¹ç”¨æ˜ç»† -->
        <div class="fee-breakdown">
          <div class="fee-row">
            <span class="fee-label">äº¤æ˜“é‡‘é¢</span>
            <span class="fee-value" id="feeAmount">0.00 USDT</span>
          </div>
          <div class="fee-row">
            <span class="fee-label">å¹³å°æœåŠ¡è´¹ (0.5%-1%)</span>
            <span class="fee-value" id="feeService">0.00 USDT</span>
          </div>
          <div class="fee-row">
            <span class="fee-label">ç½‘ç»œæ‰‹ç»­è´¹ï¼ˆé¢„ä¼°ï¼‰</span>
            <span class="fee-value" id="feeNetwork">1.00 USDT</span>
          </div>
          <div class="fee-row">
            <span class="fee-label">é£é™©ä¿è¯é‡‘</span>
            <span class="fee-value" id="feeDeposit">0.00 USDT</span>
          </div>
          <div class="fee-row total">
            <span class="fee-label">éœ€æ”¯ä»˜æ€»é¢</span>
            <span class="fee-value" id="feeTotal">0.00 USDT</span>
          </div>
        </div>
        
        <div class="btn-group">
          <button type="button" class="btn btn-secondary" onclick="saveDraft()">
            ğŸ’¾ ä¿å­˜è‰ç¨¿
          </button>
          <button type="submit" class="btn btn-primary">
            ğŸš€ åˆ›å»ºæ‹…ä¿äº¤æ˜“
          </button>
        </div>
      </form>
    </div>
    
    <!-- å³ä¾§ä¿¡æ¯ -->
    <div>
      <!-- å®‰å…¨ç‰¹æ€§ -->
      <div class="security-features">
        <h3 style="font-size:18px;margin-bottom:20px;">ğŸ”’ å®‰å…¨ä¿éšœ</h3>
        <div class="feature-list">
          <div class="feature-item">
            <div class="feature-icon">âœ“</div>
            <div class="feature-content">
              <div class="feature-title">æ™ºèƒ½åˆçº¦æ‰˜ç®¡</div>
              <div class="feature-desc">èµ„é‡‘é”å®šåœ¨æ™ºèƒ½åˆçº¦ï¼Œä»»ä½•ä¸€æ–¹æ— æ³•å•ç‹¬æå–</div>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">âœ“</div>
            <div class="feature-content">
              <div class="feature-title">é“¾ä¸ŠéªŒè¯</div>
              <div class="feature-desc">æ‰€æœ‰äº¤æ˜“éƒ½ç»è¿‡åŒºå—é“¾éªŒè¯ï¼Œç¡®ä¿çœŸå®æ€§</div>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">âœ“</div>
            <div class="feature-content">
              <div class="feature-title">äº‰è®®ä»²è£</div>
              <div class="feature-desc">ä¸“ä¸šå›¢é˜Ÿä»‹å…¥ï¼ŒåŸºäºè¯æ®é“¾å…¬æ­£è£å†³</div>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">âœ“</div>
            <div class="feature-content">
              <div class="feature-title">æ—¶æ•ˆä¿æŠ¤</div>
              <div class="feature-desc">è¶…æ—¶è‡ªåŠ¨å¤„ç†ï¼Œé¿å…èµ„é‡‘é•¿æœŸå†»ç»“</div>
            </div>
          </div>
          <div class="feature-item">
            <div class="feature-icon">âœ“</div>
            <div class="feature-content">
              <div class="feature-title">ä¿¡èª‰ç³»ç»Ÿ</div>
              <div class="feature-desc">åŸºäºå†å²äº¤æ˜“çš„åŠ¨æ€ä¿¡èª‰è¯„åˆ†æœºåˆ¶</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- å®æ—¶äº¤æ˜“ -->
      <div class="card live-transactions">
        <h3 style="font-size:16px;margin-bottom:16px;">ğŸ“Š å®æ—¶äº¤æ˜“åŠ¨æ€</h3>
        <div id="liveTransactions">
          <!-- åŠ¨æ€äº¤æ˜“åˆ—è¡¨ -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// å…¨å±€å˜é‡
let currentRole = 'buyer';
let riskScore = 25;
let currentUserAddress = '';
let isLoggedIn = false;

// ========== ç»Ÿä¸€çš„å¼¹çª—ç³»ç»Ÿ ==========

// æ˜¾ç¤ºè‡ªå®šä¹‰å¼¹çª—
function showModal(options) {
  const {
    icon = '',
    title = 'æç¤º',
    subtitle = '',
    content = '',
    type = 'info',
    size = 'small',
    buttons = [
      { text: 'ç¡®å®š', type: 'primary', action: () => closeModal() }
    ],
    onClose = null
  } = options;
  
  const iconMap = {
    success: 'âœ…',
    warning: 'âš ï¸',
    error: 'âŒ',
    info: 'â„¹ï¸',
    question: 'â“'
  };
  
  const modalHTML = `
    <div id="customModal" class="modal-overlay">
      <div class="modal-container ${size}">
        ${icon || iconMap[type] ? `
          <div class="modal-header">
            <span class="modal-icon">${icon || iconMap[type]}</span>
            <div class="modal-title">${title}</div>
            ${subtitle ? `<div class="modal-subtitle">${subtitle}</div>` : ''}
          </div>
        ` : `
          <div class="modal-header">
            <div class="modal-title">${title}</div>
            ${subtitle ? `<div class="modal-subtitle">${subtitle}</div>` : ''}
          </div>
        `}
        
        ${content ? `<div class="modal-body">${content}</div>` : ''}
        
        <div class="modal-actions">
          ${buttons.map((btn, index) => `
            <button class="modal-btn modal-btn-${btn.type || 'secondary'}" 
                    onclick="handleModalAction(${index})">
              ${btn.text}
            </button>
          `).join('')}
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // ä¿å­˜æŒ‰é’®åŠ¨ä½œ
  window.modalButtons = buttons;
  window.modalOnClose = onClose;
}

// å¤„ç†å¼¹çª—æŒ‰é’®åŠ¨ä½œ
function handleModalAction(index) {
  const button = window.modalButtons[index];
  if (button.action) {
    button.action();
  }
  if (!button.preventClose) {
    closeModal();
  }
}

// å…³é—­å¼¹çª—
function closeModal() {
  const modal = document.getElementById('customModal');
  if (modal) {
    modal.remove();
    if (window.modalOnClose) {
      window.modalOnClose();
    }
  }
}

// æ˜¾ç¤º Toast é€šçŸ¥
function showToast(message, type = 'info', duration = 3000) {
  const iconMap = {
    success: 'âœ…',
    warning: 'âš ï¸',
    error: 'âŒ',
    info: 'â„¹ï¸'
  };
  
  const toastHTML = `
    <div class="toast ${type}" id="toast-${Date.now()}">
      <span class="toast-icon">${iconMap[type]}</span>
      <span class="toast-message">${message}</span>
      <span class="toast-close" onclick="this.parentElement.remove()">âœ•</span>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', toastHTML);
  
  const toast = document.body.lastElementChild;
  setTimeout(() => {
    if (toast && toast.parentElement) {
      toast.remove();
    }
  }, duration);
}

// ========== ä¸šåŠ¡é€»è¾‘ ==========

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', function() {
  // åˆå§‹åŒ–
  document.getElementById('walletAddress').value = '';
  
  // ç›‘å¬å›è½¦é”®
  document.getElementById('walletAddress').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !isLoggedIn) {
      handleLogin();
    }
  });
  
  // åˆå§‹åŒ–è¡¨å•æäº¤
  document.getElementById('escrowForm').addEventListener('submit', handleFormSubmit);
  
  // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
  updateFees();
  startLiveUpdates();
  initializeLiveTransactions();
});

// éªŒè¯é’±åŒ…åœ°å€æ ¼å¼
function isValidWalletAddress(address) {
  const trc20Pattern = /^T[A-Za-z0-9]{33}$/;
  const erc20Pattern = /^0x[a-fA-F0-9]{40}$/;
  return trc20Pattern.test(address) || erc20Pattern.test(address);
}

// æ£€æµ‹åœ°å€ç±»å‹
function detectAddressType(address) {
  if (address.startsWith('T') && address.length === 34) {
    return 'TRC-20';
  } else if (address.startsWith('0x') && address.length === 42) {
    return 'ERC-20/BEP-20';
  }
  return 'Unknown';
}

// ç™»å…¥åŠŸèƒ½
function handleLogin() {
  const addressInput = document.getElementById('walletAddress');
  const address = addressInput.value.trim();
  
  if (!address) {
    showModal({
      type: 'warning',
      title: 'è¯·è¾“å…¥é’±åŒ…åœ°å€',
      content: 'è¯·åœ¨è¾“å…¥æ¡†ä¸­å¡«å†™æ‚¨çš„USDTé’±åŒ…åœ°å€',
      buttons: [
        { 
          text: 'ç¡®å®š', 
          type: 'primary',
          action: () => {
            document.getElementById('walletAddress').focus();
          }
        }
      ]
    });
    return;
  }
  
  if (!isValidWalletAddress(address)) {
    showModal({
      type: 'error',
      title: 'é’±åŒ…åœ°å€æ ¼å¼é”™è¯¯',
      content: `æ”¯æŒçš„é’±åŒ…åœ°å€æ ¼å¼ï¼š

- TRC-20 (æ³¢åœº): ä»¥Tå¼€å¤´ï¼Œ34ä½
  ç¤ºä¾‹: TN8Rf5PbEXe4XZDGt5H7dQBWoAMphDpg8K

- ERC-20 (ä»¥å¤ªåŠ): ä»¥0xå¼€å¤´ï¼Œ42ä½
  ç¤ºä¾‹: 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb4

- BEP-20 (å¸å®‰é“¾): ä»¥0xå¼€å¤´ï¼Œ42ä½
  ç¤ºä¾‹: 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb4

è¯·æ£€æŸ¥æ‚¨çš„é’±åŒ…åœ°å€æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼`,
      size: 'medium',
      buttons: [
        { text: 'é‡æ–°è¾“å…¥', type: 'primary' }
      ]
    });
    return;
  }
  
  const addressType = detectAddressType(address);
  console.log('é’±åŒ…åœ°å€ç±»å‹:', addressType);
  
  currentUserAddress = address;
  isLoggedIn = true;
  
  addressInput.disabled = true;
  document.getElementById('loginStatusBadge').classList.add('show');
  
  const shortAddress = address.substring(0, 6) + '...' + address.substring(address.length - 4);
  document.getElementById('userAddressDisplay').textContent = shortAddress;
  document.getElementById('userAddressDisplay').title = address;
  
  document.getElementById('userScore').textContent = '80';
  document.getElementById('kycLevel').textContent = '1';
  
  showModal({
    type: 'success',
    title: 'ç™»å½•æˆåŠŸ',
    content: `é’±åŒ…åœ°å€ç±»å‹ï¼š${addressType}
é’±åŒ…åœ°å€ï¼š${shortAddress}

æ¬¢è¿ä½¿ç”¨æ˜“è¶£SafePayæ‹…ä¿äº¤æ˜“å¹³å°`,
    buttons: [
      { text: 'å¼€å§‹ä½¿ç”¨', type: 'primary' }
    ]
  });
}

// é‡æ–°ç™»å…¥åŠŸèƒ½
function handleReset() {
  isLoggedIn = false;
  currentUserAddress = '';
  
  const addressInput = document.getElementById('walletAddress');
  addressInput.value = '';
  addressInput.disabled = false;
  
  document.getElementById('loginStatusBadge').classList.remove('show');
  document.getElementById('userAddressDisplay').textContent = 'æœªç™»å½•';
  document.getElementById('userAddressDisplay').title = '';
  document.getElementById('userScore').textContent = '--';
  document.getElementById('kycLevel').textContent = '-';
  
  addressInput.focus();
  
  showToast('å·²é€€å‡ºç™»å½•', 'info');
}

// è§’è‰²é€‰æ‹©
function selectRole(role, element) {
  currentRole = role;
  document.querySelectorAll('.role-option').forEach(opt => opt.classList.remove('selected'));
  element.classList.add('selected');
  updateRiskAssessment();
}

// åœ°å€æ£€æŸ¥
function checkAddress(address) {
  if (!address || address.length < 20) return;
  
  if (!isValidWalletAddress(address)) {
    document.getElementById('addressWarning').innerHTML = 
      'âš ï¸ æ— æ•ˆçš„é’±åŒ…åœ°å€æ ¼å¼ï¼è¯·è¾“å…¥æ­£ç¡®çš„TRC-20ã€ERC-20æˆ–BEP-20åœ°å€';
    document.getElementById('addressWarning').style.display = 'block';
    document.getElementById('addressRisk').textContent = 'æ ¼å¼é”™è¯¯';
    document.getElementById('addressRisk').style.color = 'var(--danger)';
    return;
  }
  
  setTimeout(() => {
    const riskyAddresses = ['TRX123', 'TRY456'];
    const isRisky = riskyAddresses.some(risky => address.includes(risky));
    
    if (isRisky) {
      document.getElementById('addressWarning').innerHTML = 
        'âš ï¸ è¯¥åœ°å€å­˜åœ¨é£é™©è®°å½•';
      document.getElementById('addressWarning').style.display = 'block';
      document.getElementById('addressRisk').textContent = 'âš ï¸ é«˜é£é™©';
      document.getElementById('addressRisk').style.color = 'var(--danger)';
    } else {
      document.getElementById('addressWarning').style.display = 'none';
      document.getElementById('addressRisk').textContent = 'âœ“ å®‰å…¨';
      document.getElementById('addressRisk').style.color = 'var(--success)';
    }
    
    document.getElementById('counterpartyRep').textContent = '80 åˆ†';
    updateRiskAssessment();
  }, 1000);
}

// æ›´æ–°é£é™©è¯„ä¼°
function updateRiskAssessment() {
  const amount = parseFloat(document.getElementById('amount').value) || 0;
  const transactionType = document.getElementById('transactionType').value;
  
  let score = 25;
  
  if (amount > 10000) {
    score += 30;
    document.getElementById('amountRisk').textContent = 'âš ï¸ å¤§é¢';
  } else if (amount > 5000) {
    score += 15;
    document.getElementById('amountRisk').textContent = 'ä¸­ç­‰';
  } else {
    document.getElementById('amountRisk').textContent = 'æ­£å¸¸';
  }
  
  if (transactionType === 'digital') {
    score += 10;
  }
  
  riskScore = Math.min(100, score);
  document.getElementById('riskScore').textContent = riskScore;
  
  const riskLevel = document.getElementById('riskLevel');
  if (riskScore < 40) {
    riskLevel.textContent = 'ä½é£é™©';
    riskLevel.className = 'risk-level risk-low';
  } else if (riskScore < 70) {
    riskLevel.textContent = 'ä¸­é£é™©';
    riskLevel.className = 'risk-level risk-medium';
  } else {
    riskLevel.textContent = 'é«˜é£é™©';
    riskLevel.className = 'risk-level risk-high';
  }
  
  updateFees();
}

// æ›´æ–°è´¹ç”¨
function updateFees() {
  const amount = parseFloat(document.getElementById('amount').value) || 0;
  const network = document.getElementById('network').value;
  
  let serviceFeeRate = riskScore < 40 ? 0.005 : riskScore < 70 ? 0.007 : 0.01;
  const serviceFee = amount * serviceFeeRate;
  
  const networkFees = {
    'TRC20': 1,
    'ERC20': 5,
    'BEP20': 0.5
  };
  const networkFee = networkFees[network] || 1;
  
  const deposit = amount === 0 ? 0 : (riskScore > 70 ? amount * 0.05 : 5);
  
  const totalAmount = amount + serviceFee + networkFee + deposit;
  
  document.getElementById('feeAmount').textContent = amount.toFixed(2) + ' USDT';
  document.getElementById('feeService').textContent = serviceFee.toFixed(2) + ' USDT';
  document.getElementById('feeNetwork').textContent = networkFee.toFixed(2) + ' USDT';
  document.getElementById('feeDeposit').textContent = deposit.toFixed(2) + ' USDT';
  document.getElementById('feeTotal').textContent = totalAmount.toFixed(2) + ' USDT';
}

// ä¿å­˜è‰ç¨¿
function saveDraft() {
  if (!isLoggedIn) {
    showModal({
      type: 'warning',
      title: 'è¯·å…ˆç™»å½•',
      content: 'è¯·å…ˆç™»å½•é’±åŒ…åœ°å€åå†ä¿å­˜è‰ç¨¿',
      buttons: [
        { 
          text: 'å»ç™»å½•', 
          type: 'primary',
          action: () => {
            document.getElementById('walletAddress').focus();
          }
        }
      ]
    });
    return;
  }
  
  const formData = {
    role: currentRole,
    counterpartyAddress: document.getElementById('counterpartyAddress').value,
    amount: document.getElementById('amount').value,
    network: document.getElementById('network').value,
    escrowPeriod: document.getElementById('escrowPeriod').value,
    transactionType: document.getElementById('transactionType').value,
    description: document.getElementById('description').value,
    userAddress: currentUserAddress
  };
  
  localStorage.setItem('escrowDraft', JSON.stringify(formData));
  showToast('è‰ç¨¿å·²ä¿å­˜', 'success');
}

// æäº¤è¡¨å•
function handleFormSubmit(e) {
  e.preventDefault();
  
  if (!isLoggedIn) {
    showModal({
      type: 'warning',
      title: 'è¯·å…ˆç™»å½•',
      content: 'è¯·å…ˆç™»å½•é’±åŒ…åœ°å€åå†åˆ›å»ºäº¤æ˜“',
      buttons: [
        { 
          text: 'å»ç™»å½•', 
          type: 'primary',
          action: () => {
            document.getElementById('walletAddress').focus();
          }
        }
      ]
    });
    return;
  }
  
  const counterpartyAddress = document.getElementById('counterpartyAddress').value.trim();
  if (!counterpartyAddress) {
    showModal({
      type: 'error',
      title: 'è¯·è¾“å…¥å¯¹æ–¹é’±åŒ…åœ°å€',
      content: 'å¯¹æ–¹é’±åŒ…åœ°å€æ˜¯å¿…å¡«é¡¹',
      buttons: [
        { 
          text: 'ç¡®å®š', 
          type: 'primary',
          action: () => {
            document.getElementById('counterpartyAddress').focus();
          }
        }
      ]
    });
    return;
  }
  
  if (!isValidWalletAddress(counterpartyAddress)) {
    showModal({
      type: 'error',
      title: 'å¯¹æ–¹é’±åŒ…åœ°å€æ ¼å¼æ— æ•ˆ',
      content: 'è¯·ç¡®ä¿åœ°å€æ ¼å¼æ­£ç¡®ï¼š\nâ€¢ TRC-20: Tå¼€å¤´ï¼Œ34ä½\nâ€¢ ERC-20/BEP-20: 0xå¼€å¤´ï¼Œ42ä½',
      buttons: [
        { 
          text: 'é‡æ–°è¾“å…¥', 
          type: 'primary',
          action: () => {
            document.getElementById('counterpartyAddress').focus();
          }
        }
      ]
    });
    return;
  }
  
  const amount = parseFloat(document.getElementById('amount').value);
  
  if (!amount || amount < 10) {
    showModal({
      type: 'error',
      title: 'äº¤æ˜“é‡‘é¢é”™è¯¯',
      content: 'æœ€å°äº¤æ˜“é‡‘é¢ä¸º 10 USDT',
      buttons: [
        { 
          text: 'ç¡®å®š', 
          type: 'primary',
          action: () => {
            document.getElementById('amount').focus();
          }
        }
      ]
    });
    return;
  }
  
  // ä¸å†å¯¹æè¿°è¿›è¡Œå¿…å¡«éªŒè¯
  const description = document.getElementById('description').value.trim();
  
  if (riskScore > 70) {
    showModal({
      type: 'warning',
      icon: 'âš ï¸',
      title: 'é£é™©æç¤º',
      content: `å½“å‰äº¤æ˜“é£é™©è¯„åˆ†ï¼š${riskScore}
å»ºè®®è°¨æ…äº¤æ˜“ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`,
      buttons: [
        { text: 'å–æ¶ˆ', type: 'secondary' },
        { 
          text: 'ç»§ç»­äº¤æ˜“', 
          type: 'warning',
          action: () => processTransaction()
        }
      ]
    });
    return;
  }
  
  processTransaction();
}

// å¤„ç†äº¤æ˜“
function processTransaction() {
  const amount = parseFloat(document.getElementById('amount').value);
  const network = document.getElementById('network').value;
  const counterpartyAddress = document.getElementById('counterpartyAddress').value.trim();
  const description = document.getElementById('description').value.trim();
  
  let serviceFeeRate = riskScore < 40 ? 0.005 : riskScore < 70 ? 0.007 : 0.01;
  const serviceFee = amount * serviceFeeRate;
  
  const networkFees = {
    'TRC20': 1,
    'ERC20': 5,
    'BEP20': 0.5
  };
  const networkFee = networkFees[network] || 1;
  
  const deposit = riskScore > 70 ? amount * 0.05 : 5;
  const totalAmount = amount + serviceFee + networkFee + deposit;
  
  const txId = 'ESC' + Date.now().toString(36).toUpperCase();
  
  const transaction = {
    id: txId,
    role: currentRole,
    userAddress: currentUserAddress,
    userScore: 80,
    counterpartyAddress: counterpartyAddress,
    counterpartyScore: 80,
    amount: amount,
    serviceFee: serviceFee,
    networkFee: networkFee,
    deposit: deposit,
    totalAmount: totalAmount,
    network: network,
    escrowPeriod: document.getElementById('escrowPeriod').value,
    transactionType: document.getElementById('transactionType').value,
    description: description || 'æš‚æ— æè¿°',  // å¦‚æœä¸ºç©ºåˆ™è®¾ç½®é»˜è®¤å€¼
    riskScore: riskScore,
    status: 'CREATED',
    createdAt: new Date().toISOString()
  };
  
  console.log('ä¿å­˜çš„äº¤æ˜“æ•°æ®:', transaction);
  
  sessionStorage.setItem('currentTransaction', JSON.stringify(transaction));
  localStorage.setItem('latestTransaction', JSON.stringify(transaction));
  
  // æ˜¾ç¤ºè´¹ç”¨æ˜ç»†å¼¹çª—
  const feeDetails = `
    <div class="modal-info-section">
      <div class="modal-info-title">è´¹ç”¨æ˜ç»†</div>
      <div class="modal-info-row">
        <span>äº¤æ˜“é‡‘é¢</span>
        <span>${amount.toFixed(2)} USDT</span>
      </div>
      <div class="modal-info-row">
        <span>æœåŠ¡è´¹</span>
        <span>${serviceFee.toFixed(2)} USDT</span>
      </div>
      <div class="modal-info-row">
        <span>ç½‘ç»œè´¹</span>
        <span>${networkFee.toFixed(2)} USDT</span>
      </div>
      <div class="modal-info-row">
        <span>ä¿è¯é‡‘</span>
        <span>${deposit.toFixed(2)} USDT</span>
      </div>
      <div class="modal-info-row" style="border-top:1px solid var(--border);padding-top:8px;margin-top:8px;font-weight:600;">
        <span>æ€»è®¡</span>
        <span style="color:var(--primary);">${totalAmount.toFixed(2)} USDT</span>
      </div>
    </div>
  `;
  
  showModal({
    type: 'success',
    title: 'äº¤æ˜“åˆ›å»ºæˆåŠŸ',
    subtitle: `äº¤æ˜“ID: ${txId}`,
    content: feeDetails,
    size: 'medium',
    buttons: [
      { 
        text: 'å‰å¾€æ”¯ä»˜', 
        type: 'primary',
        action: () => {
          window.location.href = './dbjy1.html';
        }
      }
    ]
  });
}

// åˆå§‹åŒ–å®æ—¶äº¤æ˜“
function initializeLiveTransactions() {
  const container = document.getElementById('liveTransactions');
  if (!container) return;
  
  // åˆå§‹äº¤æ˜“æ•°æ®
  const initialTransactions = [
    { address: 'TN8Rf5Pb...g8K', amount: 500.00, time: 'åˆšåˆš' },
    { address: '0x742d35...bEb4', amount: 1200.00, time: '2åˆ†é’Ÿå‰' },
    { address: 'TWqkE8Vt...3nH', amount: 89.99, time: '5åˆ†é’Ÿå‰' }
  ];
  
  initialTransactions.forEach(tx => {
    const item = createTransactionItem(tx.address, tx.amount, tx.time);
    container.insertAdjacentHTML('beforeend', item);
  });
}

// åˆ›å»ºäº¤æ˜“é¡¹
function createTransactionItem(address, amount, time) {
  return `
    <div class="transaction-item" style="animation: fadeIn 0.5s">
      <span class="transaction-status status-active"></span>
      <div class="transaction-info">
        <div class="transaction-id">${address}</div>
        <div><span class="transaction-amount">${amount.toFixed(2)} USDT</span> â€¢ ${time}</div>
      </div>
    </div>
  `;
}

// ç”Ÿæˆéšæœºåœ°å€
function generateRandomAddress() {
  const networks = ['TRC20', 'ERC20', 'BEP20'];
  const network = networks[Math.floor(Math.random() * networks.length)];
  
  if (network === 'TRC20') {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz123456789';
    let middle = '';
    for (let i = 0; i < 4; i++) {
      middle += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    let end = '';
    for (let i = 0; i < 3; i++) {
      end += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return `T${middle}...${end}`;
  } else {
    const hex = '0123456789abcdef';
    let middle = '';
    for (let i = 0; i < 6; i++) {
      middle += hex.charAt(Math.floor(Math.random() * hex.length));
    }
    let end = '';
    for (let i = 0; i < 4; i++) {
      end += hex.charAt(Math.floor(Math.random() * hex.length));
    }
    return `0x${middle}...${end}`;
  }
}

// ç”Ÿæˆéšæœºé‡‘é¢
function generateRandomAmount() {
  const ranges = [
    { min: 50, max: 200, decimal: true },
    { min: 200, max: 500, decimal: true },
    { min: 500, max: 1000, decimal: false },
    { min: 1000, max: 3000, decimal: false },
    { min: 3000, max: 10000, decimal: false },
    { min: 100, max: 999, decimal: true },
    { min: 50, max: 499, decimal: true }
  ];
  
  const range = ranges[Math.floor(Math.random() * ranges.length)];
  const base = Math.floor(Math.random() * (range.max - range.min) + range.min);
  
  if (range.decimal && Math.random() > 0.3) {
    const decimal = Math.floor(Math.random() * 99);
    return base + decimal / 100;
  }
  
  return base;
}

// å®æ—¶äº¤æ˜“æ›´æ–°
function startLiveUpdates() {
  setInterval(() => {
    const container = document.getElementById('liveTransactions');
    if (!container) return;
    
    const address = generateRandomAddress();
    const amount = generateRandomAmount();
    const newTransaction = createTransactionItem(address, amount, 'åˆšåˆš');
    
    container.insertAdjacentHTML('afterbegin', newTransaction);
    
    // æ›´æ–°æ—¶é—´
    const items = container.querySelectorAll('.transaction-item');
    items.forEach((item, index) => {
      if (index === 1) {
        item.querySelector('.transaction-info > div:last-child').innerHTML = 
          item.querySelector('.transaction-info > div:last-child').innerHTML.replace(/[^â€¢]+$/, ' 2åˆ†é’Ÿå‰');
      } else if (index === 2) {
        item.querySelector('.transaction-info > div:last-child').innerHTML = 
          item.querySelector('.transaction-info > div:last-child').innerHTML.replace(/[^â€¢]+$/, ' 5åˆ†é’Ÿå‰');
      } else if (index === 3) {
        item.querySelector('.transaction-info > div:last-child').innerHTML = 
          item.querySelector('.transaction-info > div:last-child').innerHTML.replace(/[^â€¢]+$/, ' 8åˆ†é’Ÿå‰');
      }
    });
    
    while (container.children.length > 5) {
      container.removeChild(container.lastChild);
    }
  }, Math.random() * 5000 + 5000); // 5-10ç§’éšæœº
}
</script>

</body>
</html>
