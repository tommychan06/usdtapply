<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ˜“æ¸ SafePay - å®‰å…¨æ”¯ä»˜éªŒè¯</title>
<style>
  :root{
    --bg-dark:#0a0e1a;
    --bg-card:#131825;
    --bg-hover:#1a2235;
    --border:#2a3245;
    --text-primary:#ffffff;
    --text-secondary:#94a3b8;
    --text-muted:#64748b;
    --primary:#3b82f6;
    --primary-dark:#2563eb;
    --success:#10b981;
    --warning:#f59e0b;
    --danger:#ef4444;
    --info:#06b6d4;
  }
  
  *{margin:0;padding:0;box-sizing:border-box}
  
  body{
    background:var(--bg-dark);
    background-image:radial-gradient(circle at 20% 80%, #1e40af15 0%, transparent 50%),
                     radial-gradient(circle at 80% 20%, #7c3aed15 0%, transparent 50%);
    font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
    color:var(--text-primary);
    min-height:100vh;
  }
  
  .container{
    max-width:1200px;
    margin:0 auto;
    padding:24px;
  }
  
  /* é¡¶éƒ¨è¿›åº¦æ¡ */
  .progress-header{
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:24px;
    margin-bottom:32px;
  }
  
  .progress-steps{
    display:flex;
    justify-content:space-between;
    position:relative;
    margin-bottom:16px;
  }
  
  .progress-line-bg{
    position:absolute;
    top:20px;
    left:0;
    right:0;
    height:2px;
    background:var(--border);
  }
  
  .progress-line{
    position:absolute;
    top:20px;
    left:0;
    height:2px;
    background:linear-gradient(90deg, var(--primary), var(--info));
    transition:width 0.5s;
  }
  
  .step{
    position:relative;
    text-align:center;
    flex:1;
  }
  
  .step-circle{
    width:40px;
    height:40px;
    margin:0 auto 8px;
    background:var(--bg-card);
    border:2px solid var(--border);
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    font-size:14px;
    position:relative;
    z-index:1;
  }
  
  .step.completed .step-circle{
    background:var(--success);
    border-color:var(--success);
    color:white;
  }
  
  .step.active .step-circle{
    background:var(--primary);
    border-color:var(--primary);
    color:white;
    box-shadow:0 0 0 8px rgba(59,130,246,0.1);
    animation:pulse 2s infinite;
  }
  
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(59,130,246,0.4)}
    70%{box-shadow:0 0 0 15px rgba(59,130,246,0)}
    100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}
  }
  
  .step-label{
    font-size:12px;
    color:var(--text-muted);
  }
  
  .step.active .step-label{
    color:var(--text-primary);
    font-weight:500;
  }
  
  /* äº¤æ˜“çŠ¶æ€æ  */
  .status-bar{
    display:flex;
    justify-content:space-between;
    padding:12px;
    background:var(--bg-hover);
    border-radius:10px;
  }
  
  .status-item{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:13px;
  }
  
  .status-dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:var(--success);
  }
  
  /* ä¸»å¸ƒå±€ */
  .main-layout{
    display:grid;
    grid-template-columns:2fr 1fr;
    gap:24px;
  }
  
  .card{
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:20px;
    padding:28px;
  }
  
  .card-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:24px;
  }
  
  .card-title{
    font-size:20px;
    font-weight:600;
  }
  
  /* æ”¯ä»˜æ–¹å¼é€‰æ‹© */
  .payment-methods{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
    gap:12px;
    margin-bottom:24px;
  }
  
  .payment-method{
    padding:16px;
    background:var(--bg-hover);
    border:2px solid var(--border);
    border-radius:12px;
    cursor:pointer;
    transition:all 0.3s;
    text-align:center;
  }
  
  .payment-method:hover{
    border-color:var(--primary);
    background:rgba(59,130,246,0.05);
  }
  
  .payment-method.selected{
    border-color:var(--primary);
    background:rgba(59,130,246,0.1);
  }
  
  .payment-method-name{
    font-size:14px;
    font-weight:600;
    margin-top:8px;
  }
  
  .payment-method-fee{
    font-size:11px;
    color:var(--text-muted);
    margin-top:4px;
  }
  
  /* æ”¯ä»˜ä¿¡æ¯ */
  .payment-info{
    background:linear-gradient(135deg, #1e40af, #7c3aed);
    border-radius:16px;
    padding:24px;
    margin-bottom:24px;
    position:relative;
    overflow:hidden;
  }
  
  .payment-info::before{
    content:'';
    position:absolute;
    top:-50%;
    right:-50%;
    width:200%;
    height:200%;
    background:radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation:rotate 20s linear infinite;
  }
  
  @keyframes rotate{
    to{transform:rotate(360deg)}
  }
  
  .payment-amount{
    font-size:36px;
    font-weight:700;
    margin-bottom:8px;
    position:relative;
    z-index:1;
  }
  
  .payment-network{
    display:inline-block;
    padding:6px 12px;
    background:rgba(255,255,255,0.2);
    border-radius:8px;
    font-size:12px;
    font-weight:600;
    position:relative;
    z-index:1;
  }
  
  /* æ”¶æ¬¾åœ°å€ */
  .address-section{
    margin-bottom:24px;
  }
  
  .address-display{
    display:flex;
    align-items:center;
    padding:16px;
    background:var(--bg-hover);
    border:1px solid var(--border);
    border-radius:12px;
    margin-bottom:12px;
  }
  
  .address-text{
    flex:1;
    font-family:'Courier New', monospace;
    font-size:14px;
    word-break:break-all;
    line-height:1.6;
  }
  
  .copy-btn{
    padding:8px 16px;
    background:var(--primary);
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-size:13px;
    font-weight:600;
    transition:all 0.3s;
    white-space:nowrap;
  }
  
  .copy-btn:hover{
    background:var(--primary-dark);
  }
  
  .copy-btn.copied{
    background:var(--success);
  }
  
  /* éªŒè¯è¾“å…¥ */
  .verification-section{
    background:var(--bg-hover);
    border-radius:12px;
    padding:20px;
    margin-bottom:24px;
  }
  
  .verification-title{
    font-size:16px;
    font-weight:600;
    margin-bottom:16px;
  }
  
  .verification-input{
    display:flex;
    gap:12px;
    margin-bottom:12px;
  }
  
  .verification-input input{
    flex:1;
    padding:12px;
    background:var(--bg-card);
    border:2px solid var(--border);
    border-radius:10px;
    color:var(--text-primary);
    font-family:'Courier New', monospace;
    font-size:13px;
    transition:all 0.3s;
  }
  
  .verification-input input:focus{
    outline:none;
    border-color:var(--primary);
  }
  
  .verification-input input.error{
    border-color:var(--danger);
    background:rgba(239,68,68,0.05);
  }
  
  .verification-input input.success{
    border-color:var(--success);
    background:rgba(16,185,129,0.05);
  }
  
  /* é”™è¯¯æç¤º */
  .hash-error-msg{
    font-size:12px;
    color:var(--danger);
    margin-top:-8px;
    margin-bottom:12px;
    padding-left:4px;
    display:none;
    animation:fadeIn 0.3s;
  }
  
  .hash-error-msg.show{
    display:flex;
    align-items:center;
    gap:4px;
  }
  
  @keyframes fadeIn{
    from{opacity:0}
    to{opacity:1}
  }
  
  .verify-btn{
    padding:12px 24px;
    background:#666;
    color:white;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-weight:600;
    transition:all 0.3s;
  }
  
  .verify-btn:hover:not(:disabled){
    background:#059669;
    transform:translateY(-1px);
  }
  
  .verify-btn:disabled{
    cursor:not-allowed;
    opacity:0.5;
  }
  
  .verify-btn.active{
    background:var(--success);
    opacity:1;
  }
  
  /* éªŒè¯çŠ¶æ€ */
  .verification-status{
    padding:12px;
    border-radius:8px;
    margin-top:12px;
    font-size:13px;
    display:none;
  }
  
  .verification-status.pending{
    display:block;
    background:rgba(245,158,11,0.1);
    border:1px solid rgba(245,158,11,0.3);
    color:var(--warning);
  }
  
  .verification-status.success{
    display:block;
    background:rgba(16,185,129,0.1);
    border:1px solid rgba(16,185,129,0.3);
    color:var(--success);
  }
  
  .verification-status.error{
    display:block;
    background:rgba(239,68,68,0.1);
    border:1px solid rgba(239,68,68,0.3);
    color:var(--danger);
  }
  
  /* å€’è®¡æ—¶ */
  .countdown-section{
    background:rgba(245,158,11,0.05);
    border:1px solid rgba(245,158,11,0.2);
    border-radius:12px;
    padding:20px;
    text-align:center;
    margin-bottom:24px;
  }
  
  .countdown-label{
    font-size:14px;
    color:var(--text-secondary);
    margin-bottom:8px;
  }
  
  .countdown-timer{
    font-size:32px;
    font-weight:700;
    color:var(--warning);
    font-family:'Courier New', monospace;
  }
  
  .countdown-warning{
    font-size:12px;
    color:var(--text-muted);
    margin-top:8px;
  }
  
  /* æ”¯ä»˜è¯æ˜ */
  .proof-upload{
    background:var(--bg-hover);
    border:2px dashed var(--border);
    border-radius:12px;
    padding:24px;
    text-align:center;
    cursor:pointer;
    transition:all 0.3s;
  }
  
  .proof-upload:hover{
    border-color:var(--primary);
    background:rgba(59,130,246,0.05);
  }
  
  .upload-icon{
    font-size:32px;
    margin-bottom:12px;
  }
  
  .upload-text{
    font-size:14px;
    color:var(--text-secondary);
    margin-bottom:8px;
  }
  
  .upload-hint{
    font-size:12px;
    color:var(--text-muted);
  }
  
  /* äº¤æ˜“è¯¦æƒ… */
  .detail-list{
    background:var(--bg-hover);
    border-radius:12px;
    padding:20px;
  }
  
  .detail-item{
    display:flex;
    justify-content:space-between;
    padding:12px 0;
    border-bottom:1px solid var(--border);
    font-size:14px;
  }
  
  .detail-item:last-child{
    border-bottom:none;
  }
  
  .detail-label{
    color:var(--text-muted);
  }
  
  .detail-value{
    color:var(--text-primary);
    font-weight:500;
  }
  
  /* å®‰å…¨æç¤º */
  .security-notice{
    background:rgba(59,130,246,0.05);
    border:1px solid rgba(59,130,246,0.2);
    border-radius:12px;
    padding:16px;
    margin-bottom:24px;
  }
  
  .notice-header{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:12px;
  }
  
  .notice-icon{
    font-size:20px;
  }
  
  .notice-title{
    font-size:14px;
    font-weight:600;
  }
  
  .notice-list{
    list-style:none;
    padding-left:32px;
    font-size:13px;
    color:var(--text-secondary);
    line-height:1.8;
  }
  
  .notice-list li{
    position:relative;
    padding-left:20px;
  }
  
  .notice-list li:before{
    content:'âœ“';
    position:absolute;
    left:0;
    color:var(--primary);
  }
  
  /* æŒ‰é’®ç»„ */
  .btn-group{
    display:flex;
    gap:12px;
    margin-top:24px;
  }
  
  .btn{
    flex:1;
    padding:14px 24px;
    border:none;
    border-radius:10px;
    font-size:15px;
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
  }
  
  .btn:hover:not(:disabled){
    transform:translateY(-2px);
    box-shadow:0 8px 20px rgba(0,0,0,0.3);
  }
  
  .btn:disabled{
    opacity:0.5;
    cursor:not-allowed;
    background:var(--bg-hover) !important;
    color:var(--text-muted) !important;
    border:1px solid var(--border);
  }
  
  .btn-primary{
    background:linear-gradient(135deg, var(--primary), var(--primary-dark));
    color:white;
  }
  
  .btn-primary.pulse{
    animation:btnPulse 1s ease-in-out infinite;
  }
  
  @keyframes btnPulse{
    0%, 100%{
      box-shadow:0 0 0 0 rgba(59,130,246,0.4);
    }
    50%{
      box-shadow:0 0 0 10px rgba(59,130,246,0);
    }
  }
  
  .btn-secondary{
    background:var(--bg-hover);
    color:var(--text-primary);
    border:1px solid var(--border);
  }
  
  .btn-danger{
    background:var(--danger);
    color:white;
  }
  
  /* åŠ è½½åŠ¨ç”» */
  .spinner{
    width:20px;
    height:20px;
    border:2px solid var(--border);
    border-top-color:var(--primary);
    border-radius:50%;
    animation:spin 1s linear infinite;
    display:inline-block;
  }
  
  @keyframes spin{
    to{transform:rotate(360deg)}
  }
  
  /* ========== ç»Ÿä¸€çš„å¼¹çª—æ ·å¼ ========== */
  
  /* å¼¹çª—é®ç½©å±‚ */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    animation: fadeInModal 0.3s ease;
  }
  
  /* å¼¹çª—å®¹å™¨ */
  .modal-container {
    background: var(--bg-card);
    background-image: radial-gradient(circle at top left, rgba(59,130,246,0.05), transparent),
                      radial-gradient(circle at bottom right, rgba(16,185,129,0.05), transparent);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 32px;
    max-width: 90%;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                0 0 100px rgba(59, 130, 246, 0.1);
    animation: slideUpModal 0.3s ease;
  }
  
  /* å¼¹çª—å¤§å°å˜ä½“ */
  .modal-container.small {
    max-width: 400px;
  }
  
  .modal-container.medium {
    max-width: 600px;
  }
  
  .modal-container.large {
    max-width: 800px;
  }
  
  /* å¼¹çª—å¤´éƒ¨ */
  .modal-header {
    text-align: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }
  
  .modal-icon {
    font-size: 48px;
    margin-bottom: 16px;
    display: block;
  }
  
  .modal-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
  }
  
  .modal-subtitle {
    font-size: 13px;
    color: var(--text-muted);
  }
  
  /* å¼¹çª—å†…å®¹ */
  .modal-body {
    margin-bottom: 24px;
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-line;
  }
  
  /* å¼¹çª—åŠ¨ä½œæŒ‰é’® */
  .modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }
  
  .modal-btn {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
    outline: none;
  }
  
  .modal-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  .modal-btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .modal-btn-primary:hover {
    background: var(--primary-dark);
  }
  
  .modal-btn-secondary {
    background: var(--bg-hover);
    color: var(--text-primary);
    border: 1px solid var(--border);
  }
  
  .modal-btn-secondary:hover {
    border-color: var(--primary);
    background: rgba(59, 130, 246, 0.1);
  }
  
  .modal-btn-success {
    background: var(--success);
    color: white;
  }
  
  .modal-btn-warning {
    background: var(--warning);
    color: white;
  }
  
  .modal-btn-danger {
    background: var(--danger);
    color: white;
  }
  
  /* Toast é€šçŸ¥æ ·å¼ */
  .toast {
    position: fixed;
    top: 24px;
    right: 24px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    z-index: 2000;
    animation: slideInRightToast 0.3s ease;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    max-width: 400px;
  }
  
  .toast-icon {
    font-size: 20px;
  }
  
  .toast-message {
    flex: 1;
    color: var(--text-primary);
  }
  
  .toast-close {
    cursor: pointer;
    opacity: 0.5;
    transition: opacity 0.3s;
  }
  
  .toast-close:hover {
    opacity: 1;
  }
  
  .toast.success {
    border-color: var(--success);
    background: linear-gradient(to right, rgba(16, 185, 129, 0.1), var(--bg-card));
  }
  
  .toast.warning {
    border-color: var(--warning);
    background: linear-gradient(to right, rgba(245, 158, 11, 0.1), var(--bg-card));
  }
  
  .toast.error {
    border-color: var(--danger);
    background: linear-gradient(to right, rgba(239, 68, 68, 0.1), var(--bg-card));
  }
  
  .toast.info {
    border-color: var(--info);
    background: linear-gradient(to right, rgba(6, 182, 212, 0.1), var(--bg-card));
  }
  
  /* åŠ¨ç”» */
  @keyframes fadeInModal {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  
  @keyframes slideUpModal {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  @keyframes slideInRightToast {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* å“åº”å¼ */
  @media (max-width:968px){
    .main-layout{
      grid-template-columns:1fr;
    }
    .modal-container {
      max-width: 95%;
      padding: 24px;
    }
  }
  
  @media (max-width:640px){
    .payment-methods{
      grid-template-columns:1fr;
    }
    .btn-group{
      flex-direction:column;
    }
    .modal-container {
      padding: 20px;
    }
    .modal-actions {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
<div class="container">
  <!-- è¿›åº¦æ¡ -->
  <div class="progress-header">
    <div class="progress-steps">
      <div class="progress-line-bg"></div>
      <div class="progress-line" id="progressLine" style="width:40%"></div>
      
      <div class="step completed">
        <div class="step-circle">âœ“</div>
        <div class="step-label">åˆ›å»ºè®¢å•</div>
      </div>
      <div class="step active">
        <div class="step-circle">2</div>
        <div class="step-label">æ”¯ä»˜éªŒè¯</div>
      </div>
      <div class="step">
        <div class="step-circle">3</div>
        <div class="step-label">èµ„é‡‘æ‰˜ç®¡</div>
      </div>
      <div class="step">
        <div class="step-circle">4</div>
        <div class="step-label">äº¤æ˜“è¿›è¡Œ</div>
      </div>
      <div class="step">
        <div class="step-circle">5</div>
        <div class="step-label">å®Œæˆç»“ç®—</div>
      </div>
    </div>
    
    <div class="status-bar">
      <div class="status-item">
        <span class="status-dot"></span>
        <span>è®¢å•çŠ¶æ€ï¼šå¾…æ”¯ä»˜</span>
      </div>
      <div class="status-item">
        <span>è®¢å•å·ï¼š<span id="orderId">--</span></span>
      </div>
      <div class="status-item">
        <span>åˆ›å»ºæ—¶é—´ï¼š<span id="createTime">--</span></span>
      </div>
    </div>
  </div>
  
  <div class="main-layout">
    <!-- å·¦ä¾§ä¸»è¦å†…å®¹ -->
    <div>
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ğŸ” å®‰å…¨æ”¯ä»˜éªŒè¯</h2>
          <span style="padding:6px 12px;background:rgba(245,158,11,0.1);color:var(--warning);border-radius:20px;font-size:12px;font-weight:600;">
            ç­‰å¾…æ”¯ä»˜
          </span>
        </div>
        
        <!-- æ”¯ä»˜æ–¹å¼ -->
        <div class="payment-methods">
          <div class="payment-method" id="method-TRC20" onclick="selectPaymentMethod('TRC20', this)">
            <div style="font-size:24px;">ğŸ”·</div>
            <div class="payment-method-name">TRC-20</div>
            <div class="payment-method-fee">æ‰‹ç»­è´¹ ~1 USDT</div>
          </div>
          <div class="payment-method" id="method-ERC20" onclick="selectPaymentMethod('ERC20', this)">
            <div style="font-size:24px;">ğŸ”¹</div>
            <div class="payment-method-name">ERC-20</div>
            <div class="payment-method-fee">æ‰‹ç»­è´¹ ~5 USDT</div>
          </div>
          <div class="payment-method" id="method-BEP20" onclick="selectPaymentMethod('BEP20', this)">
            <div style="font-size:24px;">ğŸŸ¡</div>
            <div class="payment-method-name">BEP-20</div>
            <div class="payment-method-fee">æ‰‹ç»­è´¹ ~0.5 USDT</div>
          </div>
        </div>
        
        <!-- æ”¯ä»˜ä¿¡æ¯ -->
        <div class="payment-info">
          <div class="payment-amount" id="paymentAmount">-- USDT</div>
          <span class="payment-network" id="paymentNetwork">-- Network</span>
        </div>
        
        <!-- æ”¶æ¬¾åœ°å€ -->
        <div class="address-section">
          <label style="font-size:14px;color:var(--text-secondary);margin-bottom:12px;display:block;">
            å¹³å°æ‰˜ç®¡åœ°å€ï¼ˆè¯·ä»”ç»†æ ¸å¯¹ï¼‰
          </label>
          <div class="address-display">
            <span class="address-text" id="paymentAddress">--</span>
            <button class="copy-btn" onclick="copyAddress()">å¤åˆ¶åœ°å€</button>
          </div>
          <div style="padding:8px 12px;background:rgba(16,185,129,0.1);border-radius:8px;font-size:12px;color:var(--success);display:flex;align-items:center;gap:8px;">
            <span>âœ“</span>
            <span>å·²éªŒè¯çš„å®˜æ–¹æ‰˜ç®¡åœ°å€</span>
          </div>
        </div>
        
        <!-- äº¤æ˜“éªŒè¯ -->
        <div class="verification-section">
          <h3 class="verification-title">ğŸ” æ”¯ä»˜éªŒè¯</h3>
          <div class="verification-input">
            <input type="text" id="txHash" placeholder="è¾“å…¥äº¤æ˜“å“ˆå¸Œ" maxlength="66">
          </div>
          <div class="hash-error-msg" id="hashError">
            <span>âš ï¸</span>
            <span id="hashErrorText">å“ˆå¸Œæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥è¾“å…¥</span>
          </div>
          
          <!-- æ”¯ä»˜æˆªå›¾ä¸Šä¼  -->
          <div class="proof-upload" id="proofUpload" onclick="document.getElementById('proofFile').click()">
            <div class="upload-icon">ğŸ“¸</div>
            <div class="upload-text">ç‚¹å‡»ä¸Šä¼ æ”¯ä»˜æˆªå›¾ï¼ˆå¯é€‰ï¼‰</div>
            <div class="upload-hint">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæœ€å¤§ 5MB</div>
            <input type="file" id="proofFile" style="display:none" accept="image/*">
          </div>
          
          <!-- éªŒè¯æŒ‰é’® -->
          <button class="verify-btn" id="verifyBtn" onclick="submitVerification()" disabled style="width:100%;margin-top:16px;">
            æäº¤éªŒè¯
          </button>
          
          <div class="verification-status" id="verificationStatus" style="display:none;">
            <div class="spinner"></div> æ­£åœ¨å¤„ç†...
          </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="cancelPayment()">
            âŒ å–æ¶ˆäº¤æ˜“
          </button>
          <button class="btn btn-primary" id="confirmPaymentBtn" onclick="confirmPayment()" disabled title="è¯·å…ˆæäº¤éªŒè¯">
            ğŸ”’ æˆ‘å·²æ”¯ä»˜
          </button>
        </div>
      </div>
    </div>
    
    <!-- å³ä¾§ä¿¡æ¯ -->
    <div>
      <!-- å€’è®¡æ—¶ -->
      <div class="countdown-section">
        <div class="countdown-label">â±ï¸ æ”¯ä»˜å€’è®¡æ—¶</div>
        <div class="countdown-timer" id="countdown">29:45</div>
        <div class="countdown-warning">è¶…æ—¶åè®¢å•å°†è‡ªåŠ¨å–æ¶ˆ</div>
      </div>
      
      <!-- äº¤æ˜“è¯¦æƒ… -->
      <div class="card">
        <h3 style="font-size:16px;margin-bottom:20px;">ğŸ“‹ äº¤æ˜“è¯¦æƒ…</h3>
        <div class="detail-list">
          <div class="detail-item">
            <span class="detail-label">äº¤æ˜“ç¼–å·</span>
            <span class="detail-value" id="transactionId" style="font-family:monospace;font-size:12px;">--</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">äº¤æ˜“ç±»å‹</span>
            <span class="detail-value" id="transactionType">--</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">äº¤æ˜“è§’è‰²</span>
            <span class="detail-value" id="userRole">--</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">å¯¹æ–¹åœ°å€</span>
            <span class="detail-value" id="counterpartyAddr" style="font-family:monospace;font-size:12px;">--</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">æ‰˜ç®¡æœŸé™</span>
            <span class="detail-value" id="escrowPeriod">--</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">äº¤æ˜“é‡‘é¢</span>
            <span class="detail-value" id="transactionAmount">-- USDT</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">æœåŠ¡è´¹</span>
            <span class="detail-value" id="serviceFee">-- USDT</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">ç½‘ç»œè´¹</span>
            <span class="detail-value" id="networkFee">-- USDT</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">ä¿è¯é‡‘</span>
            <span class="detail-value" id="depositAmount">-- USDT</span>
          </div>
          <div class="detail-item" style="border-top:1px solid var(--border);padding-top:16px;margin-top:8px;">
            <span class="detail-label"><strong>åº”ä»˜æ€»é¢</strong></span>
            <span class="detail-value" id="totalPayment" style="color:var(--primary);font-size:18px;font-weight:700;">-- USDT</span>
          </div>
        </div>
      </div>
      
      <!-- å®‰å…¨æç¤º -->
      <div class="security-notice">
        <div class="notice-header">
          <span class="notice-icon">ğŸ›¡ï¸</span>
          <span class="notice-title">å®‰å…¨æç¤º</span>
        </div>
        <ul class="notice-list">
          <li>è¯·ç¡®è®¤æ”¶æ¬¾åœ°å€ä¸ºå®˜æ–¹æ‰˜ç®¡åœ°å€</li>
          <li>è½¬è´¦é‡‘é¢å¿…é¡»ä¸åº”ä»˜é‡‘é¢å®Œå…¨ä¸€è‡´</li>
          <li>é€‰æ‹©æ­£ç¡®çš„ç½‘ç»œé¿å…èµ„äº§æŸå¤±</li>
          <li>è¯·ä¿å­˜å¥½äº¤æ˜“å“ˆå¸Œä½œä¸ºæ”¯ä»˜å‡­è¯</li>
          <li>æ”¯ä»˜æˆªå›¾å¯é€‰æ‹©æ€§ä¸Šä¼ è¾…åŠ©éªŒè¯</li>
          <li>å®¢æœå°†åœ¨3-5åˆ†é’Ÿå†…å®Œæˆäººå·¥éªŒè¯</li>
          <li>å¦‚æœ‰ç–‘é—®è¯·è”ç³»åœ¨çº¿å®¢æœ</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
// å…¨å±€å˜é‡
let selectedNetwork = 'TRC20';
let countdownTimer;
let paymentTimeRemaining = 1785; // 29:45 - è¿™æ˜¯æ”¯ä»˜å€’è®¡æ—¶ï¼Œä¸è¦æ··æ·†
let verificationAttempts = 0;
let hasValidHash = false;
let hasPaymentProof = false;
let hasSubmittedVerification = false;
let verificationComplete = false;

// äº¤æ˜“æ•°æ® - é»˜è®¤å€¼
let transactionData = {
  id: 'ESC' + Date.now().toString(36).toUpperCase(),
  amount: 0,
  role: 'buyer',
  transactionType: 'goods',
  riskScore: 25,
  network: 'TRC20',
  txHash: null,
  hasProof: false,
  verificationStatus: null,
  verificationTime: null,
  serviceFee: 0,
  networkFee: 1,
  deposit: 0,
  totalAmount: 0,
  counterpartyAddress: '',
  escrowPeriod: '72',  // â˜…â˜…â˜… é‡è¦ï¼šè¿™ä¸ªå€¼ä¼šä»ç¬¬ä¸€ä¸ªé¡µé¢ä¼ é€’è¿‡æ¥
  description: '',
  userAddress: '',
  userScore: 80,
  counterpartyScore: 80,
  createdAt: new Date().toISOString()
};

// ç½‘ç»œé…ç½®
const networks = {
  'TRC20': {
    name: 'TRC-20',
    address: 'TLDSPMN8HoVVRzxgn7Cm3F8FR6r9uZHESn',
    fee: 1,
    confirmations: 19,
    blockTime: 3
  },
  'ERC20': {
    name: 'ERC-20',
    address: '0x4287869bdaD2Be58b64dcc03F065fB70C4fAFCF2',
    fee: 5,
    confirmations: 12,
    blockTime: 15
  },
  'BEP20': {
    name: 'BEP-20',
    address: '0x4287869bdaD2Be58b64dcc03F065fB70C4fAFCF2',
    fee: 0.5,
    confirmations: 15,
    blockTime: 3
  }
};

// å“ˆå¸Œæ ¼å¼éªŒè¯è§„åˆ™
const hashFormats = {
  'TRC20': {
    pattern: /^[a-fA-F0-9]{64}$/,
    length: 64,
    example: '64ä½åå…­è¿›åˆ¶å­—ç¬¦',
    placeholder: 'è¾“å…¥TRC-20äº¤æ˜“å“ˆå¸Œ (64ä½åå…­è¿›åˆ¶)'
  },
  'ERC20': {
    pattern: /^0x[a-fA-F0-9]{64}$/,
    length: 66,
    example: '0xå¼€å¤´ + 64ä½åå…­è¿›åˆ¶',
    placeholder: 'è¾“å…¥ERC-20äº¤æ˜“å“ˆå¸Œ (0xå¼€å¤´ï¼Œå…±66ä½)'
  },
  'BEP20': {
    pattern: /^0x[a-fA-F0-9]{64}$/,
    length: 66,
    example: '0xå¼€å¤´ + 64ä½åå…­è¿›åˆ¶',
    placeholder: 'è¾“å…¥BEP-20äº¤æ˜“å“ˆå¸Œ (0xå¼€å¤´ï¼Œå…±66ä½)'
  }
};

// äº¤æ˜“ç±»å‹æ˜ å°„
const transactionTypeMap = {
  'goods': 'å®ç‰©å•†å“',
  'digital': 'æ•°å­—å•†å“',
  'service': 'æœåŠ¡ç±»',
  'other': 'å…¶ä»–'
};

// æ‰˜ç®¡æœŸé™æ˜ å°„
const escrowPeriodMap = {
  '24': '24å°æ—¶ - å¿«é€Ÿäº¤æ˜“',
  '72': '3å¤© - æ ‡å‡†äº¤æ˜“',
  '168': '7å¤© - å¤§é¢äº¤æ˜“',
  '360': '15å¤© - å®šåˆ¶äº¤æ˜“'
};

// ========== ç»Ÿä¸€çš„å¼¹çª—ç³»ç»Ÿ ==========

// æ˜¾ç¤ºè‡ªå®šä¹‰å¼¹çª—
function showModal(options) {
  const {
    icon = '',
    title = 'æç¤º',
    subtitle = '',
    content = '',
    type = 'info',
    size = 'small',
    buttons = [
      { text: 'ç¡®å®š', type: 'primary', action: () => closeModal() }
    ],
    onClose = null
  } = options;
  
  const iconMap = {
    success: 'âœ…',
    warning: 'âš ï¸',
    error: 'âŒ',
    info: 'â„¹ï¸',
    question: 'â“'
  };
  
  const modalHTML = `
    <div id="customModal" class="modal-overlay">
      <div class="modal-container ${size}">
        ${icon || iconMap[type] ? `
          <div class="modal-header">
            <span class="modal-icon">${icon || iconMap[type]}</span>
            <div class="modal-title">${title}</div>
            ${subtitle ? `<div class="modal-subtitle">${subtitle}</div>` : ''}
          </div>
        ` : `
          <div class="modal-header">
            <div class="modal-title">${title}</div>
            ${subtitle ? `<div class="modal-subtitle">${subtitle}</div>` : ''}
          </div>
        `}
        
        ${content ? `<div class="modal-body">${content}</div>` : ''}
        
        <div class="modal-actions">
          ${buttons.map((btn, index) => `
            <button class="modal-btn modal-btn-${btn.type || 'secondary'}" 
                    onclick="handleModalAction(${index})">
              ${btn.text}
            </button>
          `).join('')}
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // ä¿å­˜æŒ‰é’®åŠ¨ä½œ
  window.modalButtons = buttons;
  window.modalOnClose = onClose;
}

// å¤„ç†å¼¹çª—æŒ‰é’®åŠ¨ä½œ
function handleModalAction(index) {
  const button = window.modalButtons[index];
  if (button.action) {
    button.action();
  }
  if (!button.preventClose) {
    closeModal();
  }
}

// å…³é—­å¼¹çª—
function closeModal() {
  const modal = document.getElementById('customModal');
  if (modal) {
    modal.remove();
    if (window.modalOnClose) {
      window.modalOnClose();
    }
  }
}

// æ˜¾ç¤º Toast é€šçŸ¥
function showToast(message, type = 'info', duration = 3000) {
  const iconMap = {
    success: 'âœ…',
    warning: 'âš ï¸',
    error: 'âŒ',
    info: 'â„¹ï¸'
  };
  
  const toastHTML = `
    <div class="toast ${type}" id="toast-${Date.now()}">
      <span class="toast-icon">${iconMap[type]}</span>
      <span class="toast-message">${message}</span>
      <span class="toast-close" onclick="this.parentElement.remove()">âœ•</span>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', toastHTML);
  
  const toast = document.body.lastElementChild;
  setTimeout(() => {
    if (toast && toast.parentElement) {
      toast.remove();
    }
  }, duration);
}

// ========== ä¸šåŠ¡é€»è¾‘ ==========

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  // é¦–å…ˆå°è¯•ä»sessionStorageè¯»å–æ•°æ®
  let savedData = sessionStorage.getItem('currentTransaction');
  
  // å¦‚æœsessionStorageæ²¡æœ‰ï¼Œå°è¯•localStorage
  if (!savedData) {
    savedData = localStorage.getItem('latestTransaction');
  }
  
  if (savedData) {
    try {
      const transaction = JSON.parse(savedData);
      
      // åˆå¹¶ä¼ è¾“çš„æ•°æ®åˆ°transactionData
      transactionData = { ...transactionData, ...transaction };
      
      // åŠ¨æ€æ›´æ–°é¡µé¢æ˜¾ç¤º
      updatePageWithTransactionData(transaction);
      
      // æ·»åŠ è°ƒè¯•æ—¥å¿—
      console.log('åŠ è½½çš„äº¤æ˜“æ•°æ®:', transactionData);
      console.log('æ‰˜ç®¡æœŸé™:', transactionData.escrowPeriod, 'å°æ—¶');
      
    } catch (e) {
      console.error('è§£æäº¤æ˜“æ•°æ®å¤±è´¥:', e);
      // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼ç»§ç»­
    }
  } else {
    // å¦‚æœæ²¡æœ‰ä¼ è¾“æ•°æ®ï¼Œæç¤ºç”¨æˆ·å¹¶è·³è½¬å›é¦–é¡µ
    showModal({
      type: 'warning',
      title: 'æœªæ‰¾åˆ°äº¤æ˜“ä¿¡æ¯',
      content: 'è¯·é‡æ–°åˆ›å»ºè®¢å•',
      buttons: [
        {
          text: 'è¿”å›é¦–é¡µ',
          type: 'primary',
          action: () => {
            window.location.href = './dnjy.html';
          }
        }
      ]
    });
    return;
  }
  
  // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
  startCountdown();
  initHashValidation();
  updateHashFormat();
  updateConfirmPaymentButton(false);
});

// æ›´æ–°é¡µé¢æ˜¾ç¤ºå‡½æ•°
function updatePageWithTransactionData(transaction) {
  // æ›´æ–°è®¢å•ä¿¡æ¯
  if (transaction.id) {
    document.getElementById('orderId').textContent = transaction.id;
    document.getElementById('transactionId').textContent = 
      transaction.id.length > 12 ? transaction.id.substring(0, 10) + '...' : transaction.id;
  }
  
  // æ›´æ–°åˆ›å»ºæ—¶é—´
  if (transaction.createdAt) {
    const date = new Date(transaction.createdAt);
    const formattedDate = date.toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    }).replace(/\//g, '-');
    document.getElementById('createTime').textContent = formattedDate;
  }
  
  // æ›´æ–°äº¤æ˜“ç±»å‹
  if (transaction.transactionType) {
    document.getElementById('transactionType').textContent = 
      transactionTypeMap[transaction.transactionType] || transaction.transactionType;
  }
  
  // æ›´æ–°ç”¨æˆ·è§’è‰²
  if (transaction.role) {
    document.getElementById('userRole').textContent = 
      transaction.role === 'buyer' ? 'ä¹°æ–¹' : 
      transaction.role === 'seller' ? 'å–æ–¹' : transaction.role;
  }
  
  // æ›´æ–°å¯¹æ–¹åœ°å€
  if (transaction.counterpartyAddress) {
    const addr = transaction.counterpartyAddress;
    document.getElementById('counterpartyAddr').textContent = 
      addr.length > 10 ? addr.substring(0, 4) + '...' + addr.substring(addr.length - 4) : addr;
    document.getElementById('counterpartyAddr').title = addr; // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå®Œæ•´åœ°å€
  }
  
  // æ›´æ–°æ‰˜ç®¡æœŸé™
  if (transaction.escrowPeriod) {
    document.getElementById('escrowPeriod').textContent = 
      escrowPeriodMap[transaction.escrowPeriod] || transaction.escrowPeriod + 'å°æ—¶';
  }
  
  // æ›´æ–°é‡‘é¢ä¿¡æ¯
  const amount = parseFloat(transaction.amount) || 0;
  document.getElementById('transactionAmount').textContent = amount.toFixed(2) + ' USDT';
  
  // è®¡ç®—å¹¶æ›´æ–°è´¹ç”¨ï¼ˆå¦‚æœæ²¡æœ‰ä¼ è¾“è´¹ç”¨ï¼Œåˆ™é‡æ–°è®¡ç®—ï¼‰
  if (!transaction.serviceFee || !transaction.deposit) {
    const riskScore = transaction.riskScore || 25;
    const serviceFeeRate = riskScore < 40 ? 0.005 : riskScore < 70 ? 0.007 : 0.01;
    transaction.serviceFee = amount * serviceFeeRate;
    transaction.deposit = riskScore > 70 ? amount * 0.05 : 5;
  }
  
  document.getElementById('serviceFee').textContent = 
    (transaction.serviceFee || 0).toFixed(2) + ' USDT';
  document.getElementById('depositAmount').textContent = 
    (transaction.deposit || 0).toFixed(2) + ' USDT';
  
  // æ›´æ–°ç½‘ç»œé€‰æ‹©å’Œè´¹ç”¨
  if (transaction.network) {
    selectedNetwork = transaction.network;
    const networkInfo = networks[transaction.network];
    
    // è‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„ç½‘ç»œ
    selectPaymentMethod(transaction.network);
    
    // æ›´æ–°ç½‘ç»œè´¹ç”¨
    transaction.networkFee = networkInfo.fee;
    document.getElementById('networkFee').textContent = 
      '~' + networkInfo.fee.toFixed(2) + ' USDT';
  }
  
  // è®¡ç®—å¹¶æ›´æ–°æ€»é¢
  const totalAmount = amount + 
    (transaction.serviceFee || 0) + 
    (transaction.networkFee || 1) + 
    (transaction.deposit || 0);
  
  transaction.totalAmount = totalAmount;
  document.getElementById('totalPayment').textContent = totalAmount.toFixed(2) + ' USDT';
  document.getElementById('paymentAmount').textContent = totalAmount.toFixed(2) + ' USDT';
}

// åˆå§‹åŒ–å“ˆå¸ŒéªŒè¯
function initHashValidation() {
  const txHashInput = document.getElementById('txHash');
  
  // è¾“å…¥äº‹ä»¶
  txHashInput.addEventListener('input', function(e) {
    validateHashInput(this.value);
  });
  
  // ç²˜è´´äº‹ä»¶
  txHashInput.addEventListener('paste', function(e) {
    setTimeout(() => {
      validateHashInput(this.value);
    }, 10);
  });
  
  // å¤±ç„¦äº‹ä»¶
  txHashInput.addEventListener('blur', function(e) {
    if (this.value && !hasValidHash) {
      showHashError();
    }
  });
}

// éªŒè¯å“ˆå¸Œè¾“å…¥
function validateHashInput(value) {
  const txHash = value.trim();
  const inputEl = document.getElementById('txHash');
  const errorEl = document.getElementById('hashError');
  const format = hashFormats[selectedNetwork];
  
  // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€
  inputEl.classList.remove('error', 'success');
  errorEl.classList.remove('show');
  
  if (txHash.length === 0) {
    hasValidHash = false;
    updateVerifyButton();
    return;
  }
  
  // æ£€æŸ¥æ˜¯å¦ç¬¦åˆæ ¼å¼
  if (format.pattern.test(txHash)) {
    // æ ¼å¼æ­£ç¡®
    inputEl.classList.add('success');
    hasValidHash = true;
  } else {
    // æ ¼å¼é”™è¯¯
    hasValidHash = false;
    
    // åªåœ¨æ¥è¿‘é¢„æœŸé•¿åº¦æ—¶æ˜¾ç¤ºé”™è¯¯
    if (txHash.length >= format.length - 5) {
      inputEl.classList.add('error');
      showHashError();
    }
  }
  
  updateVerifyButton();
}

// æ˜¾ç¤ºå“ˆå¸Œé”™è¯¯
function showHashError() {
  const errorEl = document.getElementById('hashError');
  const errorText = document.getElementById('hashErrorText');
  const format = hashFormats[selectedNetwork];
  
  errorText.textContent = `è¯·è¾“å…¥æ­£ç¡®çš„${networks[selectedNetwork].name}äº¤æ˜“å“ˆå¸Œ (${format.example})`;
  errorEl.classList.add('show');
}

// æ›´æ–°å“ˆå¸Œæ ¼å¼
function updateHashFormat() {
  const format = hashFormats[selectedNetwork];
  document.getElementById('txHash').placeholder = format.placeholder;
  document.getElementById('txHash').maxLength = format.length;
}

// éªŒè¯å“ˆå¸Œæ ¼å¼
function validateHash(hash, network) {
  if (!hash || !hash.trim()) return false;
  const format = hashFormats[network];
  return format.pattern.test(hash.trim());
}

// æ›´æ–°éªŒè¯æŒ‰é’®çŠ¶æ€
function updateVerifyButton() {
  const verifyBtn = document.getElementById('verifyBtn');
  
  // å¦‚æœå·²ç»æäº¤éªŒè¯ï¼Œä¿æŒå½“å‰çŠ¶æ€
  if (hasSubmittedVerification) {
    return;
  }
  
  if (hasValidHash) {
    verifyBtn.disabled = false;
    verifyBtn.classList.add('active');
    verifyBtn.innerHTML = 'âœ“ æäº¤éªŒè¯';
  } else {
    verifyBtn.disabled = true;
    verifyBtn.classList.remove('active');
    verifyBtn.innerHTML = 'æäº¤éªŒè¯';
  }
}

// æ›´æ–°"æˆ‘å·²æ”¯ä»˜"æŒ‰é’®çŠ¶æ€
function updateConfirmPaymentButton(enable) {
  const confirmBtn = document.getElementById('confirmPaymentBtn');
  
  if (enable) {
    confirmBtn.disabled = false;
    confirmBtn.innerHTML = 'âœ… æˆ‘å·²æ”¯ä»˜';
    confirmBtn.title = 'ç‚¹å‡»ç¡®è®¤æ”¯ä»˜';
    confirmBtn.classList.add('pulse');
    
    setTimeout(() => {
      confirmBtn.classList.remove('pulse');
    }, 3000);
  } else {
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = 'ğŸ”’ æˆ‘å·²æ”¯ä»˜';
    confirmBtn.title = 'è¯·å…ˆæäº¤éªŒè¯';
    confirmBtn.classList.remove('pulse');
  }
}

// æäº¤éªŒè¯
function submitVerification() {
  const txHash = document.getElementById('txHash').value.trim();
  
  if (!txHash) {
    showModal({
      type: 'error',
      title: 'è¯·è¾“å…¥äº¤æ˜“å“ˆå¸Œ',
      content: 'è¯·åœ¨è¾“å…¥æ¡†ä¸­å¡«å†™äº¤æ˜“å“ˆå¸Œåå†æäº¤éªŒè¯',
      buttons: [
        {
          text: 'ç¡®å®š',
          type: 'primary',
          action: () => {
            document.getElementById('txHash').focus();
          }
        }
      ]
    });
    return;
  }
  
  // å†æ¬¡éªŒè¯å“ˆå¸Œæ ¼å¼
  if (!validateHash(txHash, selectedNetwork)) {
    const format = hashFormats[selectedNetwork];
    showModal({
      type: 'error',
      title: 'äº¤æ˜“å“ˆå¸Œæ ¼å¼ä¸æ­£ç¡®',
      content: `è¯·è¾“å…¥æœ‰æ•ˆçš„${networks[selectedNetwork].name}ç½‘ç»œäº¤æ˜“å“ˆå¸Œã€‚\n\næ ¼å¼è¦æ±‚ï¼š${format.example}\né•¿åº¦è¦æ±‚ï¼š${format.length}ä½`,
      buttons: [
        {
          text: 'é‡æ–°è¾“å…¥',
          type: 'primary',
          action: () => {
            document.getElementById('txHash').classList.add('error');
            document.getElementById('txHash').focus();
            showHashError();
          }
        }
      ]
    });
    return;
  }
  
  // æ ‡è®°å·²æäº¤éªŒè¯
  hasSubmittedVerification = true;
  
  // ä¿å­˜äº¤æ˜“å“ˆå¸Œ
  transactionData.txHash = txHash;
  transactionData.verificationTime = new Date().toISOString();
  transactionData.hasProof = hasPaymentProof;
  
  // æ˜¾ç¤ºå¤„ç†çŠ¶æ€
  const statusEl = document.getElementById('verificationStatus');
  statusEl.style.display = 'block';
  statusEl.className = 'verification-status pending';
  statusEl.innerHTML = '<div class="spinner"></div> æ­£åœ¨æäº¤éªŒè¯èµ„æ–™...';
  
  // ç¦ç”¨è¾“å…¥å’ŒæŒ‰é’®
  document.getElementById('txHash').disabled = true;
  document.getElementById('verifyBtn').disabled = true;
  
  // æ¨¡æ‹Ÿæäº¤è¿‡ç¨‹
  setTimeout(() => {
    statusEl.className = 'verification-status success';
    statusEl.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;">
        <span style="font-size:20px;">ğŸ‘¨â€ğŸ’¼</span>
        <div>
          <div style="font-weight:600;color:var(--success);">å¹³å°å®¢æœ KF0531 å·²æ¥æ”¶éªŒè¯è¯·æ±‚</div>
          <div style="font-size:11px;margin-top:4px;color:var(--text-secondary);">
            æ­£åœ¨éªŒè¯å“ˆå¸Œ: ${txHash.substring(0, 10)}...${txHash.substring(txHash.length - 8)}
          </div>
          <div style="font-size:11px;margin-top:2px;color:var(--text-secondary);">
            é¢„è®¡ 3-5 åˆ†é’Ÿå†…å®Œæˆäººå·¥å®¡æ ¸
          </div>
        </div>
      </div>
    `;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.getElementById('verifyBtn').innerHTML = 'â³ éªŒè¯ä¸­...';
    document.getElementById('verifyBtn').style.background = '#666';
    
    // ç«‹å³å¯ç”¨"æˆ‘å·²æ”¯ä»˜"æŒ‰é’®
    updateConfirmPaymentButton(true);
    
    // æ›´æ–°äº¤æ˜“çŠ¶æ€
    transactionData.verificationStatus = 'PENDING';
    updateTransactionStatus('VERIFYING');
    
    showToast('éªŒè¯è¯·æ±‚å·²æäº¤ï¼Œå®¢æœæ­£åœ¨å¤„ç†...', 'info');
    
    // 15ç§’åæ˜¾ç¤ºéªŒè¯æˆåŠŸ
    setTimeout(() => {
      statusEl.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="font-size:20px;">âœ…</span>
          <div>
            <div style="font-weight:600;color:var(--success);">æ”¯ä»˜éªŒè¯æˆåŠŸï¼</div>
            <div style="font-size:11px;margin-top:4px;color:var(--text-secondary);">
              äº¤æ˜“å“ˆå¸Œå·²ç¡®è®¤ | é‡‘é¢æ ¸å¯¹æ— è¯¯ | å¯ç‚¹å‡»"æˆ‘å·²æ”¯ä»˜"è¿›å…¥ä¸‹ä¸€æ­¥
            </div>
          </div>
        </div>
      `;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.getElementById('verifyBtn').innerHTML = 'âœ… éªŒè¯æˆåŠŸ';
      document.getElementById('verifyBtn').style.background = 'var(--success)';
      
      // æ ‡è®°éªŒè¯å®Œæˆ
      verificationComplete = true;
      transactionData.verificationStatus = 'SUCCESS';
      updateTransactionStatus('VERIFIED');
      
      showToast('æ”¯ä»˜éªŒè¯æˆåŠŸï¼è¯·ç‚¹å‡»"æˆ‘å·²æ”¯ä»˜"ç»§ç»­', 'success', 5000);
      
    }, 15000);
    
  }, 1500);
}

// é€‰æ‹©æ”¯ä»˜æ–¹å¼
function selectPaymentMethod(network, element) {
  selectedNetwork = network;
  transactionData.network = network;
  
  // æ›´æ–°UI
  document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
  
  if (element) {
    element.classList.add('selected');
  } else {
    const methodElement = document.getElementById('method-' + network);
    if (methodElement) {
      methodElement.classList.add('selected');
    }
  }
  
  // æ›´æ–°åœ°å€å’Œç½‘ç»œæ˜¾ç¤º
  const networkInfo = networks[network];
  document.getElementById('paymentAddress').textContent = networkInfo.address;
  document.getElementById('paymentNetwork').textContent = networkInfo.name + ' Network';
  
  // æ›´æ–°ç½‘ç»œè´¹ç”¨
  document.getElementById('networkFee').textContent = '~' + networkInfo.fee.toFixed(2) + ' USDT';
  transactionData.networkFee = networkInfo.fee;
  
  // æ›´æ–°å“ˆå¸Œè¾“å…¥æ¡†
  updateHashFormat();
  
  // æ¸…ç©ºå¹¶é‡æ–°éªŒè¯å½“å‰è¾“å…¥
  const txHashInput = document.getElementById('txHash');
  if (txHashInput.value) {
    validateHashInput(txHashInput.value);
  }
  
  // é‡æ–°è®¡ç®—æ€»é¢
  const amount = parseFloat(transactionData.amount) || 0;
  const total = amount + 
    (transactionData.serviceFee || 0) + 
    networkInfo.fee + 
    (transactionData.deposit || 0);
  
  transactionData.totalAmount = total;
  
  document.getElementById('totalPayment').textContent = total.toFixed(2) + ' USDT';
  document.getElementById('paymentAmount').textContent = total.toFixed(2) + ' USDT';
}

// å¤åˆ¶åœ°å€
function copyAddress() {
  const address = document.getElementById('paymentAddress').textContent;
  if (address === '--') {
    showToast('è¯·å…ˆé€‰æ‹©æ”¯ä»˜ç½‘ç»œ', 'warning');
    return;
  }
  
  navigator.clipboard.writeText(address).then(() => {
    const btn = event.target;
    btn.textContent = 'âœ“ å·²å¤åˆ¶';
    btn.classList.add('copied');
    showToast('åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    setTimeout(() => {
      btn.textContent = 'å¤åˆ¶åœ°å€';
      btn.classList.remove('copied');
    }, 2000);
  }).catch(() => {
    // é™çº§æ–¹æ¡ˆ
    const tempInput = document.createElement('input');
    tempInput.value = address;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);
    
    const btn = event.target;
    btn.textContent = 'âœ“ å·²å¤åˆ¶';
    btn.classList.add('copied');
    showToast('åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    setTimeout(() => {
      btn.textContent = 'å¤åˆ¶åœ°å€';
      btn.classList.remove('copied');
    }, 2000);
  });
}

// å€’è®¡æ—¶ - è¿™æ˜¯æ”¯ä»˜å€’è®¡æ—¶ï¼Œä¸æ˜¯æ‰˜ç®¡å€’è®¡æ—¶
function startCountdown() {
  countdownTimer = setInterval(() => {
    if (paymentTimeRemaining <= 0) {
      clearInterval(countdownTimer);
      handleTimeout();
      return;
    }
    
    paymentTimeRemaining--;
    const minutes = Math.floor(paymentTimeRemaining / 60);
    const seconds = paymentTimeRemaining % 60;
    document.getElementById('countdown').textContent = 
      `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // æœ€å5åˆ†é’Ÿè­¦å‘Š
    if (paymentTimeRemaining === 300) {
      showModal({
        type: 'warning',
        title: 'æ”¯ä»˜æ—¶é—´ä»…å‰©5åˆ†é’Ÿ',
        content: 'è¯·å°½å¿«å®Œæˆæ”¯ä»˜ï¼Œè¶…æ—¶åè®¢å•å°†è‡ªåŠ¨å–æ¶ˆ',
        buttons: [
          { text: 'çŸ¥é“äº†', type: 'primary' }
        ]
      });
    }
  }, 1000);
}

// è¶…æ—¶å¤„ç†
function handleTimeout() {
  showModal({
    type: 'error',
    title: 'æ”¯ä»˜è¶…æ—¶',
    content: 'è®¢å•å·²è‡ªåŠ¨å–æ¶ˆï¼Œè¯·é‡æ–°åˆ›å»ºäº¤æ˜“',
    buttons: [
      {
        text: 'è¿”å›é¦–é¡µ',
        type: 'primary',
        action: () => {
          updateTransactionStatus('EXPIRED');
          window.location.href = './dnjy.html';
        }
      }
    ]
  });
}

// ç¡®è®¤æ”¯ä»˜
function confirmPayment() {
  if (!hasSubmittedVerification) {
    showModal({
      type: 'warning',
      title: 'è¯·å…ˆæäº¤éªŒè¯',
      content: 'è¯·å…ˆç‚¹å‡»"æäº¤éªŒè¯"æŒ‰é’®è¿›è¡ŒéªŒè¯ï¼Œç„¶åæ‰èƒ½ç¡®è®¤æ”¯ä»˜ã€‚',
      buttons: [
        {
          text: 'å»éªŒè¯',
          type: 'primary',
          action: () => {
            const verifyBtn = document.getElementById('verifyBtn');
            if (!verifyBtn.disabled) {
              verifyBtn.style.animation = 'pulse 0.5s ease-in-out 3';
              setTimeout(() => {
                verifyBtn.style.animation = '';
              }, 1500);
            } else {
              document.getElementById('txHash').focus();
            }
          }
        }
      ]
    });
    return;
  }
  
  // ä¿å­˜æ•°æ®å¹¶è·³è½¬
  saveAndRedirect();
}

// â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šä¿å­˜æ•°æ®å¹¶è·³è½¬ â˜…â˜…â˜…
function saveAndRedirect() {
  // æ›´æ–°äº¤æ˜“çŠ¶æ€
  transactionData.status = 'PAID';
  transactionData.paymentTime = new Date().toISOString();
  
  // â˜…â˜…â˜… å…³é”®ä¿®å¤ï¼šä¸è¦ä¼ é€’æ”¯ä»˜å€’è®¡æ—¶ä½œä¸ºremainingTime â˜…â˜…â˜…
  // åˆ é™¤è¿™è¡Œï¼Œè®©ç¬¬ä¸‰ä¸ªé¡µé¢æ ¹æ®æ‰˜ç®¡æœŸé™è‡ªè¡Œè®¡ç®—
  // transactionData.remainingTime = paymentTimeRemaining;  âŒ åˆ é™¤è¿™è¡Œ
  
  // â˜…â˜…â˜… å¯é€‰ï¼šå¦‚æœæƒ³ä¿ç•™æ”¯ä»˜å€’è®¡æ—¶ä¿¡æ¯ï¼Œç”¨ä¸åŒçš„å­—æ®µå â˜…â˜…â˜…
  transactionData.paymentCountdownRemaining = paymentTimeRemaining;  // è®°å½•æ”¯ä»˜é¡µé¢çš„å‰©ä½™æ—¶é—´
  
  // â˜…â˜…â˜… ç¡®ä¿æ‰˜ç®¡æœŸé™è¢«æ­£ç¡®ä¼ é€’ â˜…â˜…â˜…
  console.log('ä¿å­˜å‰çš„æ‰˜ç®¡æœŸé™:', transactionData.escrowPeriod, 'å°æ—¶');
  console.log('å®Œæ•´çš„äº¤æ˜“æ•°æ®:', transactionData);
  
  // ä¿å­˜åˆ°sessionStorageå’ŒlocalStorage
  sessionStorage.setItem('currentTransaction', JSON.stringify(transactionData));
  localStorage.setItem('latestTransaction', JSON.stringify(transactionData));
  
  // åœæ­¢å€’è®¡æ—¶
  clearInterval(countdownTimer);
  
  showToast('æ”¯ä»˜ç¡®è®¤æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...', 'success');
  
  // è·³è½¬åˆ°dbjy2.html
  setTimeout(() => {
    window.location.href = './dbjy2.html';
  }, 1000);
}

// å–æ¶ˆæ”¯ä»˜
function cancelPayment() {
  showModal({
    type: 'question',
    title: 'ç¡®å®šè¦å–æ¶ˆäº¤æ˜“å—ï¼Ÿ',
    content: 'å–æ¶ˆåéœ€è¦é‡æ–°åˆ›å»ºè®¢å•',
    buttons: [
      { text: 'ç»§ç»­æ”¯ä»˜', type: 'secondary' },
      {
        text: 'ç¡®å®šå–æ¶ˆ',
        type: 'danger',
        action: () => {
          clearInterval(countdownTimer);
          updateTransactionStatus('CANCELLED');
          showToast('äº¤æ˜“å·²å–æ¶ˆ', 'error');
          setTimeout(() => {
            window.location.href = './dnjy.html';
          }, 1500);
        }
      }
    ]
  });
}

// æ›´æ–°äº¤æ˜“çŠ¶æ€
function updateTransactionStatus(status) {
  transactionData.status = status;
  transactionData.updatedAt = new Date().toISOString();
  sessionStorage.setItem('currentTransaction', JSON.stringify(transactionData));
  localStorage.setItem('latestTransaction', JSON.stringify(transactionData));
}

// æ–‡ä»¶ä¸Šä¼ å¤„ç†
document.getElementById('proofFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    if (file.size > 5 * 1024 * 1024) {
      showModal({
        type: 'error',
        title: 'æ–‡ä»¶è¿‡å¤§',
        content: 'æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB',
        buttons: [
          { text: 'é‡æ–°é€‰æ‹©', type: 'primary' }
        ]
      });
      return;
    }
    
    // æ›´æ–°ä¸Šä¼ åŒºåŸŸæ˜¾ç¤º
    const proofUpload = document.getElementById('proofUpload');
    proofUpload.innerHTML = `
      <div style="color:var(--success);text-align:center;">
        <div style="font-size:32px;">âœ…</div>
        <div style="margin-top:8px;font-weight:600;">æ”¯ä»˜æˆªå›¾å·²ä¸Šä¼ </div>
        <div style="font-size:12px;margin-top:4px;color:var(--text-muted);">${file.name}</div>
        <div style="font-size:11px;margin-top:4px;color:var(--text-secondary);">ç‚¹å‡»å¯é‡æ–°ä¸Šä¼ </div>
      </div>
      <input type="file" id="proofFileNew" style="display:none" accept="image/*">
    `;
    
    // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
    proofUpload.onclick = () => {
      const newInput = document.getElementById('proofFileNew') || document.getElementById('proofFile');
      if (newInput) newInput.click();
    };
    
    // æ›´æ–°çŠ¶æ€
    hasPaymentProof = true;
    transactionData.hasProof = true;
    
    showToast('æˆªå›¾ä¸Šä¼ æˆåŠŸ', 'success');
  }
});
</script>
</body>
</html>